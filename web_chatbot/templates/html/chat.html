<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Mate – 채팅 & 세션 로그</title>
<style>
  :root{ --sidebar-w:300px; --line:#e5e7eb; --muted:#6b7280; --bubble:#f5f6f8; --user:#fff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111}

  /* ===== 사이드바 ===== */
  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--sidebar-w);
    background:#f9fafb;border-right:1px solid var(--line);
    transform:translateX(calc(-1 * var(--sidebar-w)));transition:transform .35s ease;z-index:20;
    display:flex;flex-direction:column;justify-content:space-between;
  }
  body.sidebar-open .sidebar{transform:translateX(0)}
  .sidebar-header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .brand{font-family:"Times New Roman",serif;font-weight:700;font-size:22px;margin-right:auto;cursor:pointer}
  .brand:active{transform:translateY(1px)}
  .new-chat{
    font-size:14px;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer
  }
  .sidebar-body{padding:8px 8px 14px;overflow-y:auto;flex:1}
  .chat-item{
    position:relative;
    display:flex;align-items:center;gap:8px;
    padding:10px 10px;border-radius:10px;cursor:pointer;
  }
  .chat-item:hover{background:#f3f4f6}
  .chat-main{min-width:0;flex:1;display:flex;flex-direction:column;gap:2px}
  .chat-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chat-snippet{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* ⋯ 버튼 + 메뉴 */
  .more-wrap{position:relative}
  .more-btn{
    opacity:0; transition:opacity .15s ease;
    border:1px solid var(--line); background:#fff; border-radius:8px;
    padding:6px 8px; font-size:16px; line-height:1; cursor:pointer; user-select:none;
  }
  .chat-item:hover .more-btn{opacity:1}
  .more-menu{
    position:absolute; right:0; top:36px; min-width:140px;
    background:#fff; border:1px solid var(--line); border-radius:10px;
    box-shadow:0 10px 28px rgba(0,0,0,.12); padding:6px; display:none; z-index:60;
  }
  .more-menu.open{display:block}
  .mm-item{padding:10px 12px; border-radius:8px; font-size:14px}
  .mm-item:hover{background:#f5f6f8}
  .mm-danger{color:#b91c1c}

  /* 이메일 footer + 팝오버 */
  .sidebar-footer{position:relative;border-top:1px solid var(--line);padding:12px 14px;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px;cursor:pointer}
  .sidebar-footer .mail{font-size:14px;color:#111}
  .sidebar-footer:hover{background:#f3f4f6}
  .account-menu{position:absolute;left:10px;bottom:48px;min-width:180px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:6px;display:none;z-index:50}
  .account-menu.open{display:block}
  .account-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none}
  .account-item:hover{background:#f3f4f6}
  .account-item.danger{color:#b91c1c}

  /* 오버레이 + ☰ 버튼 */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.05);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:15}
  body.sidebar-open .overlay{opacity:1;pointer-events:auto}
  .toggle-btn{position:fixed;top:14px;left:14px;z-index:30;width:42px;height:42px;border:1px solid var(--line);border-radius:10px;background:#fff;display:grid;place-items:center;cursor:pointer;user-select:none;box-shadow:0 1px 6px rgba(0,0,0,.06);transition:transform .35s ease}
  body.sidebar-open .toggle-btn{transform:translateX(var(--sidebar-w))}

  /* ===== 카테고리 선택 박스 ===== */
  .topic{ position:fixed; top:14px; left:66px; z-index:30; transition:transform .35s ease; }
  body.sidebar-open .topic{ transform:translateX(var(--sidebar-w)); }
  .topic-btn{
    min-width:120px; height:42px; padding:0 12px; border:1px solid var(--line); border-radius:10px;
    background:#fff; display:flex; align-items:center; gap:8px; cursor:pointer; box-shadow:0 1px 6px rgba(0,0,0,.06);
    font-size:15px;
  }
  .chev{ font-size:16px; color:#888; margin-left:auto }
  .topic-panel{
    position:absolute; top:48px; left:0; width:320px; max-width:92vw;
    border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:0 10px 28px rgba(0,0,0,.12);
    padding:8px; display:none;
  }
  .topic-panel.open{ display:block; }
  .topic-item{ padding:12px; border-radius:10px; cursor:pointer; position:relative; }
  .topic-item:hover{ background:#f5f6f8; }

  .topic-item:hover::after {
    content: attr(data-tooltip);
    white-space: pre-wrap;
    position: absolute;
    top: 110%;
    left: 0;
    background: #f9fafb;
    color: #111;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.6;
    z-index: 200;
    width: max-content;
    max-width: 320px;
    animation: fadeInTooltip 0.2s ease-out forwards;
  }

  @keyframes fadeInTooltip {
    0% { opacity: 0; transform: translateY(6px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  .topic-title{ font-size:18px; font-weight:800; letter-spacing:-.02em; margin:0 0 4px }
  .topic-sub{ font-size:13px; color:#777; margin:0 }
  .topic-item small{ color:#999; font-weight:700; margin-left:6px }

  /* ===== 화면 전환 공통 ===== */
  .screen{opacity:1;transform:translateY(0);transition:opacity .35s ease, transform .35s ease}
  .screen.hidden{opacity:0;transform:translateY(10px);pointer-events:none;position:absolute;inset:0}

  /* ===== 인트로(첫 화면) ===== */
  .main-wrap{min-height:100vh;display:grid;place-items:center;padding:40px 16px;transition:transform .35s ease}
  body.sidebar-open .main-wrap{transform:translateX(var(--sidebar-w))}
  .center{text-align:center}
  .headline{font-size:34px;margin:0 0 12px;font-weight:700;letter-spacing:-.02em}
  .rm-italic{font-family:"Times New Roman",Georgia,serif;font-style:italic;font-weight:600}
  .sub{color:var(--muted);margin-bottom:22px}
  .search{width:min(720px,92vw);border:1px solid var(--line);border-radius:20px;padding:14px 16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
  .search input{width:100%;border:0;outline:0;font-size:15px;background:transparent}

  /* ===== 채팅 화면 ===== */
  .chat-wrap{display:flex;flex-direction:column;min-height:100vh;padding:60px 16px 24px 16px;transition:transform .35s ease}
  body.sidebar-open .chat-wrap{transform:translateX(var(--sidebar-w))}
  .chat-area{flex:1;border:1px solid var(--line);border-radius:16px;padding:16px;overflow-y:auto;background:#fff}
  .row{display:flex;margin:6px 0}
  .row.user{justify-content:flex-end}
  .msg{max-width:78%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.55;white-space:pre-wrap;word-break:break-word}
  .row.user .msg{background:var(--user);border:1px solid var(--line);border-bottom-right-radius:6px}
  .row.bot  .msg{background:var(--bubble);border-bottom-left-radius:6px}
  .composer{display:flex;gap:10px;margin-top:12px}
  .composer input{flex:1;border:1px solid var(--line);border-radius:18px;padding:14px 16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .composer input:focus{outline:none;border-color:#b9c1ff;box-shadow:0 0 0 3px rgba(124,140,248,.2)}

  @media (max-width:640px){:root{--sidebar-w:260px}.headline{font-size:26px}}

  /* ===== 회원탈퇴 모달 ===== */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:80; }
  .modal-wrap{ position:fixed; inset:0; display:grid; place-items:center; z-index:90; pointer-events:none; }
  .modal{ width:min(920px,94vw); border-radius:20px; background:#fff; box-shadow:0 16px 50px rgba(0,0,0,.18);
          padding:28px 28px 34px; transform:translateY(10px); opacity:0; transition:.25s ease;
          pointer-events:auto; }
  .modal.open{ transform:translateY(0); opacity:1; }
  .modal-header{ font-size:20px; font-weight:800; letter-spacing:-.02em; margin-bottom:8px }
  .modal-desc{ color:#4b5563; line-height:1.6; font-size:15px; margin-bottom:18px }
  .modal-list{ margin:0 0 22px 0; padding-left:22px; color:#4b5563 }
  .modal-list b{ color:#111 }
  .cta{ display:block; width:100%; text-align:center; font-size:32px; font-weight:900; letter-spacing:-.02em;
        padding:26px 20px; border:0; border-radius:26px; background:#eef694; cursor:pointer }
  .cta:active{ transform:translateY(1px) }
  .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px }
  .btn{ border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer }
</style>
</head>
<body class="sidebar-open">

  <!-- ☰ 메뉴 -->
  <button class="toggle-btn" id="btn" aria-label="메뉴 열기/닫기">☰</button>

  <!-- 카테고리 선택 -->
  <div class="topic" id="topic">
    <button class="topic-btn" id="topicBtn" aria-haspopup="listbox" aria-expanded="false">
      <span id="topicLabel">청년톡</span><span class="chev">▾</span>
    </button>
    <div class="topic-panel" id="topicPanel" role="listbox" aria-label="카테고리">
      <div class="topic-item" data-value="청년톡" role="option" aria-selected="true"
        data-tooltip="무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당하는 미혼 청년
- 만 19~39세 미혼 청년
- 대학생(입학 및 복학 예정자 포함)
- 졸업·중퇴 2년 이내 미취업자"
      >
        <p class="topic-title">청년톡</p>
        <p class="topic-sub">청년의 이야기, 청년을 위한 대화</p>
      </div>
      <div class="topic-item" data-value="신혼부부톡 (I)" role="option"
        data-tooltip="무주택 요건 및 소득 자산 기준을 충족하고 다음 어느 하나에 해당하는 가구

• 신혼부부 : 공고일 기준 혼인 7년 이내인 사람
• 예비신혼부부 : 공고일 기준 혼인 예정인 사람으로서 입주일 전일까지 혼인신고를 하는 사람
• 한부모가족 : 만 6세 이하 자녀를 둔 한부모가족, 또는 미성년 자녀를 둔 지원대상 한부모가족
• 유자녀 혼인가구 : 만 6세 이하 자녀가 있는 혼인가구
• 신생아 가구 : 만 2세 이하 자녀가 있는 가구
• 혼인가구 : 공고일 기준 혼인한 가구"
      >
        <p class="topic-title">신혼부부톡 <small>(I)</small></p>
        <p class="topic-sub">두 사람의 새로운 시작을 함께하는 대화</p>
      </div>
      <div class="topic-item" data-value="신혼부부톡 (II)" role="option"
        data-tooltip="무주택 요건 및 소득 자산 기준을 충족하고 다음 어느 하나에 해당하는 가구

• 신혼부부 : 공고일 기준 혼인 7년 이내인 사람
• 예비신혼부부 : 공고일 기준 혼인 예정인 사람으로서 입주일 전일까지 혼인신고를 하는 사람
• 한부모가족 : 만 6세 이하 자녀를 둔 한부모가족, 또는 미성년 자녀를 둔 지원대상 한부모가족
• 유자녀 혼인가구 : 만 6세 이하 자녀가 있는 혼인가구
• 신생아 가구 : 만 2세 이하 자녀가 있는 가구
• 혼인가구 : 공고일 기준 혼인한 가구"
      >
        <p class="topic-title">신혼부부톡 <small>(II)</small></p>
        <p class="topic-sub">두 사람의 새로운 시작을 함께하는 대화</p>
      </div>
    </div>
  </div>

  <!-- 사이드바 -->
  <aside class="sidebar" id="sidebar">
    <div>
      <div class="sidebar-header">
        <div class="brand" id="brandBtn" title="인트로로 돌아가기">Room Mate</div>
        <button id="newChatBtn" class="new-chat">➕ 새 채팅</button>
      </div>
      <div class="sidebar-body" id="chatList"></div>
    </div>
    <div class="sidebar-footer" id="accountBtn" tabindex="0" aria-haspopup="menu" aria-expanded="false">
      <span>📧</span><span class="mail" id="user-email">Email@gmail.com</span>
      <div class="account-menu" id="accountMenu" role="menu" aria-label="계정 메뉴">
        <a class="account-item" href="intro.html" role="menuitem">로그아웃</a>
        <a class="account-item" href="password_modify.html" role="menuitem">비밀번호 수정</a>
        <a class="account-item danger" href="#" id="openWithdraw" role="menuitem" aria-haspopup="dialog">회원탈퇴</a>
      </div>
    </div>
  </aside>

  <!-- 오버레이 -->
  <div class="overlay" id="overlay"></div>

  <!-- ===== 인트로 화면 ===== -->
  <section id="intro" class="main-wrap screen">
    <div class="center">
      <h1 class="headline">내 집 마련의 첫걸음, <span class="rm-italic">Room&nbsp;Mate</span>가 함께합니다</h1>
      <p class="sub">청약부터 대출까지, 주거 고민은 Room Mate에게 맡겨보세요.</p>
      <div class="search"><input id="landingInput" type="text" placeholder="질문을 입력하세요"></div>
    </div>
  </section>

  <!-- ===== 채팅 화면 ===== -->
  <section id="chatScreen" class="screen hidden" aria-live="polite" aria-label="대화 화면">
    <div class="chat-wrap">
      <div id="chat" class="chat-area"></div>
      <div class="composer"><input id="chatInput" type="text" placeholder="질문을 입력하세요"></div>
    </div>
  </section>

  <!-- ===== 회원탈퇴 모달 ===== -->
  <div class="modal-backdrop" id="modalBg" aria-hidden="true"></div>
  <div class="modal-wrap" id="modalWrap" aria-hidden="true">
    <div class="modal" id="withdrawModal" role="dialog" aria-modal="true" aria-labelledby="withdrawTitle" aria-describedby="withdrawDesc">
      <div class="modal-header" id="withdrawTitle">회원 탈퇴 전 안내</div>
      <p class="modal-desc" id="withdrawDesc">
        지금까지 Room mate 서비스를 이용해 주셔서 정말 감사 드립니다. 더욱 개선된 서비스로 청년들에게 도움이 될 수 있도록 하겠습니다.
        탈퇴하기 전 아래 유의사항을 확인해주세요.
      </p>
      <ul class="modal-list">
        <li>탈퇴하신 아이디는 <b>복구가 불가능</b>합니다.</li>
        <li>해당 사용자의 이메일 주소, 비밀번호와 지금까지 기록된 채팅 내역들이 삭제되며, <b>삭제된 데이터는 복구되지 않습니다</b>.</li>
      </ul>
      <button class="cta" id="confirmWithdraw">확인 및 탈퇴하기</button>
      <div class="modal-actions">
        <button class="btn" id="closeWithdraw">닫기</button>
      </div>
    </div>
  </div>

<script>
/* ========= 유틸 / 스토리지 ========= */
const STORAGE_KEY = 'roommate_chats_v1';
const CURRENT_KEY = 'roommate_current_chat_id';
const TOPIC_KEY   = 'roommate_topic';
const DEFAULT_TOPIC = '청년톡';

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function loadChats(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e){ return []; } }
function saveChats(chats){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); }
function getCurrentId(){ return localStorage.getItem(CURRENT_KEY); }
function setCurrentId(id){ if(id) localStorage.setItem(CURRENT_KEY, id); else localStorage.removeItem(CURRENT_KEY); }
function getTopic(){ return localStorage.getItem(TOPIC_KEY) || DEFAULT_TOPIC; }
function setTopicLS(t){ localStorage.setItem(TOPIC_KEY, t); }

/* ========= 전역 엘리먼트 ========= */
const body=document.body, btn=document.getElementById('btn'), overlay=document.getElementById('overlay');
const chatListEl=document.getElementById('chatList');
const intro=document.getElementById('intro'), chatScreen=document.getElementById('chatScreen');
const landingIn=document.getElementById('landingInput'), chatArea=document.getElementById('chat'), chatIn=document.getElementById('chatInput');
const topicBtn=document.getElementById('topicBtn'), topicPanel=document.getElementById('topicPanel'), topicLabel=document.getElementById('topicLabel'), topicWrap=document.getElementById('topic');
const newChatBtn=document.getElementById('newChatBtn'); const brandBtn=document.getElementById('brandBtn');

/* ========= 공용 화면 전환 ========= */
function showChatScreen(){
  intro.classList.add('hidden'); chatScreen.classList.remove('hidden');
  setTimeout(()=>chatIn.focus(),120);
}
function showIntro(){
  chatScreen.classList.add('hidden'); intro.classList.remove('hidden');
  setTimeout(()=>landingIn.focus(),120);
}

/* ========= 사이드바 토글 ========= */
btn.onclick=()=>body.classList.toggle('sidebar-open');
overlay.onclick=()=>body.classList.remove('sidebar-open');
window.addEventListener('keydown',e=>{ if(e.key==='Escape') body.classList.remove('sidebar-open') });

/* ========= 브랜드 클릭 → 인트로로 ========= */
brandBtn.addEventListener('click', showIntro);

/* ========= 계정 팝오버 ========= */
document.getElementById('user-email').textContent = "Email@gmail.com";
const accountBtn=document.getElementById('accountBtn'), accountMenu=document.getElementById('accountMenu');
function closeMenu(){accountMenu.classList.remove('open');accountBtn.setAttribute('aria-expanded','false')}
function openMenu(){accountMenu.classList.add('open');accountBtn.setAttribute('aria-expanded','true')}
function toggleMenu(e){e.stopPropagation();accountMenu.classList.contains('open')?closeMenu():openMenu()}
accountBtn.addEventListener('click',toggleMenu);
accountBtn.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleMenu(e)} if(e.key==='Escape'){closeMenu()}});
document.addEventListener('click',e=>{ if(!accountBtn.contains(e.target)) closeMenu() });

/* ========= 카테고리 ========= */
function applyTopicLabel(){ topicLabel.textContent = getTopic(); }
applyTopicLabel();
function openPanel(){ topicPanel.classList.add('open'); topicBtn.setAttribute('aria-expanded','true'); }
function closePanel(){ topicPanel.classList.remove('open'); topicBtn.setAttribute('aria-expanded','false'); }
topicBtn.addEventListener('click', (e)=>{ e.stopPropagation(); topicPanel.classList.contains('open') ? closePanel() : openPanel(); });
document.addEventListener('click', (e)=>{ if(!topicWrap.contains(e.target)) closePanel(); });
topicPanel.querySelectorAll('.topic-item').forEach(it=>{
  it.addEventListener('click',()=>{ setTopicLS(it.dataset.value); applyTopicLabel(); closePanel(); });
});

/* ========= 세션(대화) 모델 ========= */
let chats = loadChats();
/*
  chat = { id, title, topic, createdAt, updatedAt, messages:[{role:'user'|'bot', text, ts}] }
*/
function createChat(initialTopic=getTopic()){
  const c = { id: uid(), title:'새 채팅', topic: initialTopic, createdAt: Date.now(), updatedAt: Date.now(), messages:[] };
  chats.unshift(c); saveChats(chats); setCurrentId(c.id); renderChatList(); return c;
}
function getChatById(id){ return chats.find(c=>c.id===id); }
function updateChat(c){ c.updatedAt = Date.now(); saveChats(chats); renderChatList(); }
function ensureCurrent(){ let id=getCurrentId(), c=id&&getChatById(id); if(!c){ c=createChat(); } return c; }

/* ========= 좌측 목록 렌더 (⋯ 메뉴 포함) ========= */
function humanTime(ts){ const d=new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
function closeAllMoreMenus(){ document.querySelectorAll('.more-menu.open').forEach(m=>m.classList.remove('open')); }
function renderChatList(){
  chatListEl.innerHTML=''; chats.sort((a,b)=>b.updatedAt-a.updatedAt);
  chats.forEach(c=>{
    const last = c.messages[c.messages.length-1];

    const item=document.createElement('div'); item.className='chat-item'; item.dataset.id=c.id; item.setAttribute('title', humanTime(c.updatedAt));

    const main=document.createElement('div'); main.className='chat-main';
    const t=document.createElement('div'); t.className='chat-title'; t.textContent=c.title || '새 채팅';
    const s=document.createElement('div'); s.className='chat-snippet'; s.textContent=(last? `${last.role==='user'?'나: ':'봇: '}${last.text}` : `${c.topic} • 대화 없음`);
    main.appendChild(t); main.appendChild(s);

    const moreWrap=document.createElement('div'); moreWrap.className='more-wrap';
    const moreBtn=document.createElement('button'); moreBtn.className='more-btn'; moreBtn.textContent='⋯';
    moreBtn.setAttribute('title','더보기'); moreBtn.setAttribute('aria-haspopup','menu');

    const menu=document.createElement('div'); menu.className='more-menu'; menu.setAttribute('role','menu');
    const openItem=document.createElement('div'); openItem.className='mm-item'; openItem.textContent='열기';
    const delItem=document.createElement('div'); delItem.className='mm-item mm-danger'; delItem.textContent='삭제';

    // 메뉴 동작
    moreBtn.addEventListener('click',(e)=>{ e.stopPropagation(); closeAllMoreMenus(); menu.classList.toggle('open'); });
    document.addEventListener('click',()=>menu.classList.remove('open'));

    openItem.addEventListener('click',(e)=>{ e.stopPropagation(); menu.classList.remove('open'); loadSession(c.id,{gotoChat:true}); });
    delItem.addEventListener('click',(e)=>{
      e.stopPropagation(); menu.classList.remove('open');
      const ok=confirm('이 대화를 삭제할까요? 복구할 수 없습니다.'); if(!ok) return;
      chats = chats.filter(x=>x.id!==c.id); saveChats(chats);
      if(getCurrentId()===c.id){ setCurrentId(null); clearChatArea(); showIntro(); }
      renderChatList();
    });

    menu.appendChild(openItem); menu.appendChild(delItem);
    moreWrap.appendChild(moreBtn); moreWrap.appendChild(menu);

    item.appendChild(main); item.appendChild(moreWrap);
    item.addEventListener('click',()=>loadSession(c.id,{gotoChat:true}));
    chatListEl.appendChild(item);
  });
}
renderChatList();

/* ========= 채팅 영역 ========= */
function clearChatArea(){ chatArea.innerHTML=''; }
function bubble(role, text){
  const row=document.createElement('div'); row.className='row ' + (role==='user'?'user':'bot');
  const b=document.createElement('div'); b.className='msg'; b.textContent=text;
  row.appendChild(b); chatArea.appendChild(row); chatArea.scrollTop=chatArea.scrollHeight;
}
function renderSession(c){ clearChatArea(); c.messages.forEach(m=>bubble(m.role, m.text)); }
function loadSession(id,{gotoChat=false}={}){ const c=getChatById(id); if(!c) return; setCurrentId(id); renderSession(c); if(gotoChat) showChatScreen(); }

/* ========= 입력 핸들러 ========= */
function addUserMessage(text){
  const c=ensureCurrent(); c.messages.push({role:'user', text, ts:Date.now()});
  if(c.title==='새 채팅'){ c.title = text.length>24 ? text.slice(0,24)+'…' : text; }
  updateChat(c); bubble('user', text);
}
function addBotMessage(text){
  const c=ensureCurrent(); c.messages.push({role:'bot', text, ts:Date.now()}); updateChat(c); bubble('bot', text);
}

/* ====== 인트로 입력: 클릭 이동 차단 + 자연스러운 전환 ====== */
// 1) 클릭 시 어떤 기본 이동/submit도 차단 (혹시 모를 잔여 코드 대비)
landingIn.addEventListener('click', (e) => {
  e.preventDefault();
  landingIn.focus();
});

// 2) 첫 글자 입력되면: 세션 생성 → 채팅화면 전환 → 입력값 동기화
let introMoved=false;
landingIn.addEventListener('input', ()=>{
  if(!introMoved && landingIn.value.length>0){
    introMoved=true;
    createChat(getTopic());           // 새 세션 생성
    showChatScreen();                 // 화면 전환
    chatIn.value = landingIn.value;   // 입력값 넘김
    setTimeout(()=>{ chatIn.selectionStart=chatIn.selectionEnd=chatIn.value.length; }, 0);
  }else if(introMoved){
    chatIn.value = landingIn.value;   // 동기화
  }
});

// 3) 인트로에서 엔터 → 전송 처리
landingIn.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    if(!introMoved){
      introMoved=true; createChat(getTopic()); showChatScreen();
      chatIn.value = landingIn.value;
    }
    const v=chatIn.value.trim(); if(!v) return;
    landingIn.value=''; chatIn.value=''; addUserMessage(v);
    setTimeout(()=>addBotMessage('임시 응답입니다. (AI 연결 예정)'), 250);
  }
});

/* 채팅 입력 */
chatIn.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const v=chatIn.value.trim(); if(!v) return;
    addUserMessage(v); chatIn.value='';
    setTimeout(()=>addBotMessage('임시 응답입니다. (AI 연결 예정)'), 250);
  }
});

/* 새 채팅 버튼 */
newChatBtn.addEventListener('click', ()=>{
  createChat(getTopic()); clearChatArea(); showChatScreen(); chatIn.value='';
  // 인트로 입력 플래그 초기화
  introMoved=false; landingIn.value='';
});

/* 첫 로드: 인트로 유지 */
if(chats.length===0){ /* keep intro */ }

/* ===== 회원탈퇴 모달 ===== */
const openWithdraw=document.getElementById('openWithdraw');
const modalBg=document.getElementById('modalBg');
const modalWrap=document.getElementById('modalWrap');
const modal=document.getElementById('withdrawModal');
const closeWithdraw=document.getElementById('closeWithdraw');
const confirmWithdraw=document.getElementById('confirmWithdraw');

function showWithdrawModal(){
  closeMenu(); modalBg.style.display='block';
  modalWrap.setAttribute('aria-hidden','false'); modalBg.setAttribute('aria-hidden','false');
  requestAnimationFrame(()=>{ modal.classList.add('open'); }); confirmWithdraw.focus();
}
function hideWithdrawModal(){
  modal.classList.remove('open'); modalWrap.setAttribute('aria-hidden','true'); modalBg.setAttribute('aria-hidden','true');
  setTimeout(()=>{ modalBg.style.display='none'; }, 200);
}
openWithdraw?.addEventListener('click', (e)=>{ e.preventDefault(); showWithdrawModal(); });
modalBg.addEventListener('click', hideWithdrawModal);
closeWithdraw?.addEventListener('click', hideWithdrawModal);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalBg.style.display==='block'){ hideWithdrawModal(); }});
confirmWithdraw?.addEventListener('click', ()=>{ window.location.href = 'intro.html'; });
</script>

</body>
</html>
