<!DOCTYPE html>
<!-- saved from url=(0060)file:///C:/my_python/AIcamp/4th/4th_project/html/exam_3.html -->
<html lang="ko"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Room Mate</title>
<style>
  /* ===== Login.html의 타이포/여백 규칙으로 통일 ===== */
  :root{
    /* 공통 컬러 토큰 */
    --bg:#fff;
    --panel:#ffffff;
    --line:#e5e7eb;
    --muted:#6b7280;
    --text:#111827;

    /* 액센트는 기존 유지 */
    --accent:#6d28d9;
    --accent-weak:#ede9fe;

    /* 요소 토큰 (login.html 기준) */
    --chip:#f3f4f6;
    --bubble:#f5f6f8;
    --shadow:0 2px 10px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.05);
    --radius:14px;
    --sidebar-w:320px;
    --header-h:56px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    --ml:var(--sidebar-w);
    min-height:100%;
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--text);
    background:var(--bg);
  }
  button{cursor:pointer;border:0;background:none;font:inherit;color:inherit}
  a{text-decoration:none;color:inherit}

  .app{min-height:100vh}

  /* ===== Sidebar ===== */
  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--sidebar-w);
    background:#fff;border-right:1px solid var(--line);
    display:flex;flex-direction:column;gap:16px;transform:translateX(0);
    transition:transform .32s ease;z-index:30;
  }
  body.sidebar-closed .sidebar{transform:translateX(-100%)}

  /* 메인 레이아웃 */
  .main{
    margin-left:var(--ml);transition:margin-left .32s ease;
    display:flex;flex-direction:column;min-height:100vh;background:#fff;
    position:relative;
  }
  body.sidebar-closed .main{margin-left:0}

  /* ===== Sidebar content ===== */
  .brand{
    display:flex;
    align-items:center;
    justify-content:space-between;
    height:70px;
    padding:0 22px;
    box-sizing:border-box;
    position:relative;
    border-bottom:1px solid var(--line);
  }
  .brand h1{
    font-family:"Times New Roman", serif;
    font-style:italic;
    font-size:22px;
    font-weight:normal;
    color:#111827;
    margin:0; line-height:1;
  }
  .logo-link{display:inline-flex;align-items:center}

  .new-chat{
    display:inline-flex; align-items:center;
    gap:6px; height:auto; padding:6px 12px;
    background:var(--accent-weak);
    border-radius:12px;
    font-weight:600; line-height:1.2;
  }
  .new-chat .plus{font-weight:700}

  .logs{padding:16px;height:100%;overflow:auto}
  .logs h2{margin:6px 0 12px 4px;font-size:16px;color:#111}
  .log{
    background:var(--chip);
    border:1px solid var(--line);
    border-radius:var(--radius); padding:12px; margin-bottom:10px;
    display:flex;justify-content:space-between;align-items:center;cursor:pointer;
  }
  .log small{color:var(--muted);font-size:13px;}
  .log.active{outline:2px solid #a78bfa}
  .log-actions{position:relative;display:flex;align-items:center;}
  .kebab{padding:4px 8px;border-radius:8px}
  .kebab:hover{background:#eef2ff}
  .log-menu{
    position:absolute;right:0;top:28px;background:#fff;
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);display:none;overflow:hidden;
  }
  .log.open .log-menu{display:block}
  .log-menu button{display:block;padding:10px 14px;width:140px;text-align:left;font-size:15px}
  .log-menu button:hover{background:#f9fafb}

  .footer{
    margin-top:auto;padding:12px 16px;border-top:1px solid var(--line);
    display:flex;align-items:center;gap:8px;position:relative;
  }
  .account{position:relative;display:inline-block}
  .email{
    display:flex;align-items:center;gap:8px;padding:10px 12px;
    border-radius:16px;background:var(--chip);
    font-size:15px;
  }
  .email-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#6366f1}
  .account-menu{
    position:absolute;bottom:56px;left:0;background:#fff;border:1px solid var(--line);
    border-radius:var(--radius);box-shadow:var(--shadow);min-width:200px;overflow:hidden;
    opacity:0;pointer-events:none;transform:translateY(10px);
    transition:opacity .2s ease, transform .2s ease;z-index:35;
  }
  .account:hover .account-menu,
  .account:focus-within .account-menu,
  .account-menu.open{opacity:1;pointer-events:auto;transform:translateY(0);}
  .menu-item{display:block;padding:12px 14px;font-size:15px}
  .menu-item:hover{background:#f9fafb}
  .menu-danger{color:#b91c1c}

  /* ===== Toolbar / Dropdown ===== */
  .toolbar{
    display:flex; gap:12px; align-items:center;
    height:56px; padding:0 22px;
    border-bottom:0;                            /* 보더 제거 */
    box-shadow:inset 0 -1px 0 var(--line);      /* ✅ 한 줄만 inset으로 고정 */
    background:#fff; position:sticky; top:0; z-index:10;
  }

  /* ⛔ 줄 겹침 원인 제거: 더 이상 필요 없음 */
  /* .main::before { 없음 } */

  .pill{
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:6px 12px;
    background:#fff; font-size:15px;
  }
  .menu-toggle{font-weight:700}
  .dropdown{position:relative}
  .dropdown-btn{display:flex;align-items:center;gap:6px;font-size:15px}

  .dropdown-list{
    position:absolute; top:57px; left:0;       /* ← 1px 띄워서 그림자 겹침 방지 */
    background:#fff;border:1px solid var(--line); border-top:none;
    border-radius:16px; box-shadow:var(--shadow);
    min-width:220px; overflow:hidden; display:none; z-index:20;
  }
  .dropdown.open .dropdown-list{display:block}
  .dropdown-item{padding:14px;font-weight:600;font-size:15px}
  .dropdown-item:hover{background:#f9fafb}

  .hovercard{
    position:absolute; top:57px; left:230px;   /* 동일하게 1px 띄움 */
    width:360px; background:#fff;
    border:1px solid var(--line); border-top:none;
    border-radius:16px; box-shadow:var(--shadow);
    padding:16px; display:none; z-index:19;
  }
  .dropdown.show-card .hovercard{display:block}
  .hovercard h4{margin:0 0 6px 0;font-size:16px}
  .hovercard p{margin:6px 0;color:var(--muted);font-size:15px}
  .hovercard ul{margin:8px 0 0 18px}
  .hovercard li{margin:4px 0}

  /* ===== Home / Chat ===== */
  .home{display:flex;align-items:center;justify-content:center;flex:1;background:#fff}
  .hero{max-width:900px;text-align:center;padding:40px}
  .hero h2{
    font-size:32px; margin:0 0 14px 0; font-weight:700;
  }
  .hero em{
    font-family:"Times New Roman", serif; font-style:italic; font-weight:400;
    font-size:1.15em; color:#111827;
  }
  .hero p{color:var(--muted);margin:4px 0 26px 0;font-size:15px}

  /* 검색창 */
  .search{
    display:flex;background:#fff;border:1px solid var(--line);
    border-radius:999px;box-shadow:var(--shadow);
    max-width:560px;margin:0 auto;overflow:hidden;
  }
  .search input{
    width:100%;padding:14px 16px;border:0;font-size:16px;outline:none;background:#fff;
  }
  .search input:focus{
    box-shadow:0 0 0 3px rgba(124,140,248,.2);
    border:0; outline:0;
  }

  .chat{flex:1;display:none;background:#fff}
  .chat.active{display:block}
  .chat-body{height:calc(100vh - 64px - 68px);overflow:auto;padding:20px}
  .msg{
    max-width:620px;padding:14px 16px;background:var(--bubble);
    border-radius:18px; font-size:15px;
  }
  .msg.me{background:#fff;border:1px solid var(--line)}
  .composer{border-top:1px solid var(--line);padding:10px;background:#fff}
  .composer .input{
    width:100%; border:1px solid var(--line); border-radius:18px;
    padding:14px 16px; font-size:15px; background:#fff;
  }
  .composer .input:focus{
    box-shadow:0 0 0 3px rgba(124,140,248,.2);
    border-color:#c7cffc; outline:0;
  }

  @media (max-width:980px){ body{--ml:0} }

  /* ✅ 두 줄 가로선 예방: 불필요한 전역 after 제거(있을 경우) */
  .app::after{ content:none !important; height:0 !important; }
</style>


</head>
<body class="sidebar-open">
<div class="app">
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" aria-label="채팅 로그 및 계정">
    <div class="brand">
      <a class="logo-link" href="file:///C:/my_python/AIcamp/4th/4th_project/html/exam_3.html#" id="logoBtn" aria-label="Room Mate 홈으로">
        <h1>Room Mate</h1>
      </a>
      <button class="new-chat" id="newChatBtn" aria-label="새 채팅 시작"><span class="plus">＋</span> 새 채팅</button>
    </div>

    <div class="logs">
      <h2>채팅로그</h2>
      <div id="logList" aria-live="polite"><div style="color: var(--muted); padding: 4px 8px;">채팅 기록이 없습니다</div></div>
    </div>

    <div class="footer">
      <div class="account" id="accountWrap">
        <div class="email" id="emailArea" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="accountMenu" aria-label="계정 메뉴 열기">
          <span class="email-dot"></span>
          <span id="emailText">Email@gmail.com</span>
        </div>
        <div class="account-menu" id="accountMenu" role="menu">
          <a class="menu-item" href="file:///C:/my_python/AIcamp/4th/4th_project/html/main.html" role="menuitem">로그아웃</a>
          <a class="menu-item" href="file:///C:/my_python/AIcamp/4th/4th_project/html/password_modify.html" role="menuitem">비밀번호 수정</a>
          <button class="menu-item menu-danger" id="openWithdraw" role="menuitem">회원탈퇴</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- ===== Main ===== -->
  <main class="main">
    <div class="toolbar">
      <button class="pill menu-toggle" id="menuToggle" aria-label="사이드바 열기/닫기">☰</button>

      <div class="dropdown" id="categoryDropdown" data-current="청년톡">
        <button class="pill dropdown-btn" id="dropdownBtn" aria-haspopup="true" aria-expanded="false">
          <span id="currentCategory">청년톡</span> ▾
        </button>

        <div class="dropdown-list" id="dropdownList">
          <div class="dropdown-item" data-cat="청년톡">청년톡</div>
          <div class="dropdown-item" data-cat="신혼부부톡 (I)">신혼부부톡 (I)</div>
          <div class="dropdown-item" data-cat="신혼부부톡 (II)">신혼부부톡 (II)</div>
        </div>

        <div class="hovercard" id="hoverCard"></div>
      </div>
    </div>

    <!-- Home -->
    <section class="home" id="homeView" aria-label="메인">
      <div class="hero">
        <h2>내 집 마련의 첫걸음, <em>Room Mate</em>가 함께합니다</h2>
        <p>청약부터 대출까지, 주거 고민은 Room Mate에게 맡겨보세요.</p>
        <form class="search" id="homeSearch" autocomplete="off">
          <input id="homeInput" type="text" placeholder="질문을 입력하세요" aria-label="질문을 입력하세요">
        </form>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat" id="chatView" aria-label="채팅">
      <div class="chat-body" id="chatBody"></div>
      <div class="composer">
        <input class="input" id="composerInput" type="text" placeholder="질문을 입력하세요">
      </div>
    </section>
  </main>
</div>

<!-- ===== Withdraw Modal ===== -->
<div class="modal-backdrop" id="withdrawModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="withdrawTitle">
    <div class="modal-header">
      <h3 id="withdrawTitle" style="margin:0;font-size:24px;font-weight:800">회원 탈퇴 전 안내</h3>
    </div>
    <div class="modal-body">
      <p style="font-size:18px;color:var(--muted)">지금까지 Room mate 서비스를 이용해 주셔서 정말 감사 드립니다. 더욱 개선된 서비스로 청년들에게 도움이 될 수 있도록 하겠습니다. 탈퇴하기 전 아래 유의사항을 확인해주세요.</p>
      <ul style="font-size:18px">
        <li>탈퇴하신 아이디는 <b>복구가 불가능</b>합니다.</li>
        <li>해당 사용자의 이메일 주소, 비밀번호와 지금까지 기록된 채팅 내역들이 삭제되며, <b>삭제된 데이터는 복구되지 않습니다.</b></li>
      </ul>
      <div class="modal-hl">확인 및 탈퇴하기</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="closeModal">닫기</button>
      <button class="btn btn-danger" id="confirmWithdraw">확인 및 탈퇴하기</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  회원 탈퇴가 완료되었습니다.
  <button id="toastOk">확인</button>
</div>

<script>
/*******************************
 * 0) Utilities & App State
 *******************************/
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const fmtTime = (d=new Date()) => d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
const API = (path) => `/api${path}`;

const state = { category:'청년톡', logs:[], conversations:{}, activeId:null };

/*******************************
 * 카테고리 설명 (hovercard)
 *******************************/
const CATEGORY_HELP = {
  '청년톡': `
    <h4>청년톡</h4>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당하는 미혼 청년</p>
    <ul>
      <li><b>만 19세 이상 만 39세 이하</b>인 사람</li>
      <li><b>대학생</b> (입학 및 복학 예정자 포함)</li>
      <li><b>취업준비생</b> (졸업·중퇴 2년 이내 미취업자)</li>
    </ul>`,
  '신혼부부톡 (I)': `
    <h4>신혼부부톡 (I)</h4>
    <p>전년도 도시근로자 가구당 월평균 소득 70% 이하(배우자 소득이 있는 경우 90% 이하) 충족, 국민임대주택 자산기준 충족</p>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p>
    <ul>
      <li><b>신혼부부</b> : 혼인 7년 이내</li>
      <li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li>
      <li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li>
      <li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li>
      <li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li>
      <li><b>혼인가구</b> : 혼인한 가구</li>
    </ul>`,
  '신혼부부톡 (II)': `
    <h4>신혼부부톡 (II)</h4>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p>
    <ul>
      <li><b>신혼부부</b> : 혼인 7년 이내</li>
      <li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li>
      <li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li>
      <li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li>
      <li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li>
      <li><b>혼인가구</b> : 혼인한 가구</li>
    </ul>`,
};

/*******************************
 * 1) Renderers
 *******************************/
const homeView = $('#homeView');
const chatView = $('#chatView');
const chatBody = $('#chatBody');
const composer = $('#composerInput');

function renderLogs(){
  const wrap = $('#logList');
  wrap.innerHTML = '';
  if(state.logs.length===0){
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.style.padding = '4px 8px';
    empty.textContent = '채팅 기록이 없습니다';
    wrap.appendChild(empty);
    return;
  }
  state.logs.forEach(log=>{
    const el = document.createElement('div');
    el.className = 'log' + (state.activeId===log.id ? ' active' : '');
    el.dataset.id = log.id;
    el.innerHTML = `
      <div class="log-main">
        <div style="font-weight:700">${log.title}</div>
        <small>${log.ts || ''}</small>
      </div>
      <div class="log-actions" data-stop>
        <button class="kebab" data-kebab title="옵션">⋯</button>
        <div class="log-menu"><button data-delete>삭제</button></div>
      </div>`;
    el.addEventListener('click', (e)=>{ if(e.target.closest('[data-stop]')) return; openConversation(log.id); });
    wrap.appendChild(el);
  });
}

function renderConversation(id){
  const conv = state.conversations[id] || [];
  chatBody.innerHTML = '';
  conv.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'msg' + (m.role==='me' ? ' me' : '');
    d.textContent = m.text;
    d.style.marginTop = '14px';
    chatBody.appendChild(d);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}

/*******************************
 * 2) View switches
 *******************************/
function goHome(){ homeView.style.display='flex'; chatView.classList.remove('active'); state.activeId=null; renderLogs(); }
function openChat(id){ homeView.style.display='none'; chatView.classList.add('active'); state.activeId=id; renderLogs(); renderConversation(id); composer.focus(); }

/*******************************
 * 3) API wiring
 *******************************/
async function apiJson(url, opts){
  const res = await fetch(url, opts);
  if(!res.ok){ const msg = await res.text().catch(()=>res.statusText); throw new Error(msg || `HTTP ${res.status}`); }
  return res.json();
}
async function fetchLogs(){ const data = await apiJson(`/api/conversations`); state.logs = data || []; renderLogs(); }
async function fetchMessages(id){ const data = await apiJson(`/api/conversations/${id}/messages`); state.conversations[id] = data || []; renderConversation(id); }
async function createNewChat(initialText=''){
  const chat = await apiJson(`/api/conversations`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({category:state.category, first_message:initialText})});
  state.logs.unshift({id:chat.id, title:chat.title, ts:new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})});
  state.conversations[chat.id] = []; if(initialText) state.conversations[chat.id].push({role:'me', text:initialText}); openChat(chat.id);
}
async function sendMessage(id, text){
  const reply = await apiJson(`/api/conversations/${id}/messages`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text})});
  if(!state.conversations[id]) state.conversations[id]=[];
  state.conversations[id].push({role:'me', text}); state.conversations[id].push({role:'bot', text:reply.answer}); renderConversation(id);
}
async function deleteChat(id){ await fetch(`/api/conversations/${id}`, {method:'DELETE'}); state.logs = state.logs.filter(l=>l.id!==id); delete state.conversations[id]; if(state.activeId===id){ goHome(); } renderLogs(); }
async function fetchProfile(){ const me = await apiJson(`/api/me`); document.querySelector('#emailText').textContent = me.email || '익명 사용자'; }
async function logout(){ await fetch(`/api/logout`, {method:'POST'}); location.href='main.html'; }
async function withdraw(){ await fetch(`/api/account`, {method:'DELETE'}); showToast(); }

/*******************************
 * 4) Events wiring
 *******************************/
document.querySelector('#menuToggle').addEventListener('click', ()=>{ document.body.classList.toggle('sidebar-closed'); });
document.querySelector('#logoBtn').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
document.querySelector('#newChatBtn').addEventListener('click', ()=> createNewChat(''));
document.querySelector('#homeSearch').addEventListener('submit', (e)=>{ e.preventDefault(); const t=document.querySelector('#homeInput').value.trim(); if(t) createNewChat(t); });

const dropdown = document.querySelector('#categoryDropdown');
const dropdownBtn = document.querySelector('#dropdownBtn');
const dropdownList = document.querySelector('#dropdownList');
const hoverCard = document.querySelector('#hoverCard');

dropdownBtn.addEventListener('click', ()=>{ dropdown.classList.toggle('open'); dropdownBtn.setAttribute('aria-expanded', dropdown.classList.contains('open')); });
[...dropdownList.querySelectorAll('.dropdown-item')].forEach(item=>{
  item.addEventListener('click', ()=>{
    const cat = item.getAttribute('data-cat');
    state.category = cat.replace(/ \(.+\)$/,'') === '신혼부부톡' ? '신혼부부톡' : cat;
    document.querySelector('#currentCategory').textContent = cat;
    dropdown.classList.remove('open','show-card'); dropdownBtn.setAttribute('aria-expanded','false');
  });
  item.addEventListener('mouseenter', (e)=>{ const key = e.target.getAttribute('data-cat'); hoverCard.innerHTML = ({"청년톡":`<h4>청년톡</h4><p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당하는 미혼 청년</p><ul><li><b>만 19세 이상 만 39세 이하</b>인 사람</li><li><b>대학생</b> (입학 및 복학 예정자 포함)</li><li><b>취업준비생</b> (졸업·중퇴 2년 이내 미취업자)</li></ul>`,"신혼부부톡 (I)":`<h4>신혼부부톡 (I)</h4><p>전년도 도시근로자 가구당 월평균 소득 70% 이하(배우자 소득이 있는 경우 90% 이하) 충족, 국민임대주택 자산기준 충족</p><p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p><ul><li><b>신혼부부</b> : 혼인 7년 이내</li><li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li><li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li><li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li><li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li><li><b>혼인가구</b> : 혼인한 가구</li></ul>`,"신혼부부톡 (II)":`<h4>신혼부부톡 (II)</h4><p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p><ul><li><b>신혼부부</b> : 혼인 7년 이내</li><li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li><li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li><li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li><li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li><li><b>혼인가구</b> : 혼인한 가구</li></ul>`}[key]||''); dropdown.classList.add('show-card'); });
});
dropdown.addEventListener('mouseleave', ()=> dropdown.classList.remove('show-card'));

const accountWrap = document.querySelector('#accountWrap');
const emailArea = document.querySelector('#emailArea');
const accountMenu = document.querySelector('#accountMenu');
emailArea.addEventListener('click', (e)=>{ e.stopPropagation(); accountMenu.classList.toggle('open'); emailArea.setAttribute('aria-expanded', accountMenu.classList.contains('open') ? 'true' : 'false'); });
document.addEventListener('click', (e)=>{ if(!accountWrap.contains(e.target)){ accountMenu.classList.remove('open'); emailArea.setAttribute('aria-expanded','false'); } });

const logoutLink = document.querySelector("#accountMenu a[href='main.html']");
if(logoutLink){ logoutLink.addEventListener('click', async (e)=>{ e.preventDefault(); await logout(); }); }

const logList = document.querySelector('#logList');
logList.addEventListener('click', async (e)=>{
  const item = e.target.closest('.log'); if(!item) return;
  const kebab = e.target.closest('[data-kebab]'); if(kebab){ e.stopPropagation(); item.classList.toggle('open'); return; }
  const delBtn = e.target.closest('[data-delete]'); if(delBtn){ e.stopPropagation(); await deleteChat(item.dataset.id); return; }
});

composer.addEventListener('keydown', async (e)=>{
  if(e.key!=='Enter') return; e.preventDefault();
  const val = composer.value.trim(); if(!val || !state.activeId) return;
  composer.value=''; await sendMessage(state.activeId, val);
});

async function openConversation(id){ openChat(id); await fetchMessages(id); }

const modal = document.querySelector('#withdrawModal');
document.querySelector('#openWithdraw').addEventListener('click', ()=>{ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); });
document.querySelector('#closeModal').addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
document.querySelector('#confirmWithdraw').addEventListener('click', async ()=>{ try{ await withdraw(); }finally{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });
const toast = document.querySelector('#toast');
function showToast(){ toast.style.display='block'; }
document.querySelector('#toastOk').addEventListener('click', ()=> window.location.href='main.html');

/*******************************
 * 5) Boot
 *******************************/
async function boot(){
  if (window.matchMedia('(max-width: 980px)').matches) { document.body.classList.add('sidebar-closed'); }
  try{ await fetchProfile(); }catch(e){}
  try{ await fetchLogs(); }catch(e){ renderLogs(); }
}
boot();
</script>

<script>
(() => {
  const wrap = document.querySelector('#logList'); if(!wrap) return;
  document.addEventListener('click', ()=>{ document.querySelectorAll('#logList .log.open').forEach(el=>el.classList.remove('open')); });
  wrap.addEventListener('click', async (e)=>{
    const logItem = e.target.closest('.log'); if(!logItem) return;
    const id = logItem.dataset.id;
    if (e.target.closest('[data-kebab]')) {
      e.stopPropagation();
      wrap.querySelectorAll('.log.open').forEach(el=>{ if(el!==logItem) el.classList.remove('open'); });
      logItem.classList.toggle('open'); return;
    }
    if (e.target.closest('[data-delete]')) {
      e.stopPropagation(); logItem.classList.remove('open');
      try{ await deleteChat(id); }catch(err){ alert('삭제에 실패했습니다. 잠시 후 다시 시도해 주세요.'); }
      return;
    }
  });
})();
</script>


</body></html>
