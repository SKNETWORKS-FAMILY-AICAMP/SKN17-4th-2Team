<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Mate</title>
<style>
  :root{
    --bg:#fafafa; --panel:#ffffff; --line:#e5e7eb; --muted:#6b7280;
    --text:#111827; --accent:#6d28d9; --accent-weak:#ede9fe;
    --chip:#f3f4f6; --bubble:#f5f6f8; --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:16px; --sidebar-w:320px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
  button{cursor:pointer;border:0;background:none;font:inherit;color:inherit}
  a{text-decoration:none;color:inherit}

  /* ===== Layout (sidebar slides) ===== */
  body{--ml:var(--sidebar-w);} 
  .app{min-height:100vh}
  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--sidebar-w);
    background:#fff;border-right:1px solid var(--line);
    display:flex;flex-direction:column;gap:16px;transform:translateX(0);
    transition:transform .32s ease;z-index:30;
  }
  .main{
    margin-left:var(--ml);transition:margin-left .32s ease;
    display:flex;flex-direction:column;min-height:100vh;background:#fff;
  }
  body.sidebar-closed .sidebar{transform:translateX(-100%)}
  body.sidebar-closed .main{margin-left:0}

  /* ===== Sidebar content ===== */
  .brand{
    display:flex;align-items:center;justify-content:space-between;
    padding:20px 24px;border-bottom:1px solid var(--line);
  }
  .brand h1{margin:0;font-size:28px;font-weight:800}
  .logo-link{display:inline-flex;align-items:center}
  .new-chat{display:inline-flex;align-items:center;gap:10px;background:var(--accent-weak);padding:10px 14px;border-radius:12px}
  .new-chat .plus{font-weight:700}
  .logs{padding:16px;height:100%;overflow:auto}
  .logs h2{margin:6px 0 12px 4px;font-size:16px;color:#111}
  .log{
    background:var(--chip);border:1px solid var(--line);border-radius:12px;
    padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;
    cursor:pointer
  }
  .log small{color:var(--muted)}
  .log.active{outline:2px solid #a78bfa}
  /* small inline kebab for delete (no structure changes) */
  .log-actions{position:relative;display:flex;align-items:center;}
  .kebab{padding:4px 8px;border-radius:8px}
  .kebab:hover{background:#eef2ff}
  .log-menu{position:absolute;right:0;top:28px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);display:none;overflow:hidden}
  .log.open .log-menu{display:block}
  .log-menu button{display:block;padding:8px 12px;width:120px;text-align:left}
  .log-menu button:hover{background:#f9fafb}

  /* ===== footer email + hover menu ===== */
  .footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--line);display:flex;align-items:center;gap:8px;position:relative}
  .account{position:relative;display:inline-block}
  .email{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--chip);}
  .email-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#6366f1}
  .account-menu{position:absolute;bottom:56px;left:0;background:#fff;border:1px solid var(--line);
    border-radius:12px;box-shadow:var(--shadow);min-width:200px;overflow:hidden;
    opacity:0;pointer-events:none;transform:translateY(10px);
    transition:opacity .2s ease, transform .2s ease;z-index:35;}
  .account:hover .account-menu,
  .account:focus-within .account-menu,
  .account-menu.open{opacity:1;pointer-events:auto;transform:translateY(0);} 
  .menu-item{display:block;padding:12px 14px}
  .menu-item:hover{background:#f9fafb}
  .menu-danger{color:#b91c1c}

  /* ===== Toolbar / Dropdown ===== */
  .toolbar{display:flex;gap:12px;align-items:center;padding:14px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:10}
  .pill{border:1px solid var(--line);border-radius:12px;padding:10px 14px;background:#fff}
  .menu-toggle{font-weight:700}
  .dropdown{position:relative}
  .dropdown-btn{display:flex;align-items:center;gap:10px}
  .dropdown-list{position:absolute;top:52px;left:0;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);min-width:220px;overflow:hidden;display:none;z-index:20}
  .dropdown.open .dropdown-list{display:block}
  .dropdown-item{padding:14px;font-weight:600}
  .dropdown-item:hover{background:#f9fafb}
  .hovercard{position:absolute;top:52px;left:230px;width:360px;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);
    padding:16px;display:none;z-index:19}
  .dropdown.show-card .hovercard{display:block}
  .hovercard h4{margin:0 0 6px 0}
  .hovercard p{margin:6px 0;color:var(--muted)}
  .hovercard ul{margin:8px 0 0 18px}
  .hovercard li{margin:4px 0}

  /* ===== Home / Chat ===== */
  .home{display:flex;align-items:center;justify-content:center;flex:1;background:#fff}
  .hero{max-width:900px;text-align:center;padding:40px}
  .hero h2{font-size:44px;margin:0 0 14px 0}
  .hero em{font-style:normal;color:var(--accent);font-weight:900}
  .hero p{color:var(--muted);margin:4px 0 26px 0}
  .search{display:flex;background:#fff;border:1px solid var(--line);border-radius:999px;box-shadow:var(--shadow);max-width:560px;margin:0 auto;overflow:hidden}
  .search input{width:100%;padding:16px 20px;border:0;font-size:16px;outline:none}

  .chat{flex:1;display:none;background:#fff}
  .chat.active{display:block}
  .chat-body{height:calc(100vh - 64px - 68px);overflow:auto;padding:20px}
  .msg{max-width:620px;padding:14px 16px;background:var(--bubble);border-radius:18px}
  .msg.me{background:#fff;border:1px solid var(--line)}
  .composer{border-top:1px solid var(--line);padding:10px;background:#fff}
  .composer .input{width:100%;border:1px solid var(--line);border-radius:999px;padding:14px 18px}

  /* ===== Modal & Toast ===== */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40}
  .modal{background:#fff;border-radius:20px;max-width:880px;width:min(92vw,880px);box-shadow:var(--shadow);overflow:hidden}
  .modal-header{padding:22px 24px;border-bottom:1px solid var(--line)}
  .modal-body{padding:20px 24px}
  .modal-hl{background:#f7fba7;border-radius:30px;padding:40px 24px;margin:18px 0 10px 0;text-align:center;font-size:36px;font-weight:800}
  .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--line)}
  .btn{border:1px solid var(--line);border-radius:12px;padding:10px 14px;background:#fff}
  .btn-primary{background:#111;color:#fff;border-color:#111}
  .btn-danger{background:#e11d48;color:#fff;border-color:#e11d48}
  .btn-ghost{background:#fff}
  .toast{position:fixed;inset:auto 24px 24px auto;background:#111;color:#fff;border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);display:none;z-index:50}
  .toast button{margin-left:12px;background:#fff;color:#111;border-radius:10px;padding:6px 10px;border:0}

  @media (max-width: 980px){ body{--ml:0} }
</style>
</head>
<body class="sidebar-open">
<div class="app">
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" aria-label="채팅 로그 및 계정">
    <div class="brand">
      <!-- 로고: 첫 화면으로 (상태 보존) -->
      <a class="logo-link" href="#" id="logoBtn" aria-label="Room Mate 홈으로">
        <h1>Room Mate</h1>
      </a>
      <button class="new-chat" id="newChatBtn" aria-label="새 채팅 시작"><span class="plus">＋</span> 새 채팅</button>
    </div>

    <div class="logs">
      <h2>채팅로그</h2>
      <div id="logList" aria-live="polite"></div>
    </div>

    <!-- Email hover = menu -->
    <div class="footer">
      <div class="account" id="accountWrap">
        <div class="email" id="emailArea" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="accountMenu" aria-label="계정 메뉴 열기">
          <span class="email-dot"></span>
          <span id="emailText">Email@gmail.com</span>
        </div>
        <div class="account-menu" id="accountMenu" role="menu">
                    <a class="menu-item" href="{% url 'user:logout' %}" role="menuitem">로그아웃</a>
                    <a class="menu-item" href="{% url 'user:password_modify' %}" role="menuitem">비밀번호 수정</a>
          <button class="menu-item menu-danger" id="openWithdraw" role="menuitem">회원탈퇴</button>
      </div>
      </div>
    </div>
  </aside>

  <!-- ===== Main ===== -->
  <main class="main">
    <!-- Toolbar -->
    <div class="toolbar">
      <button class="pill menu-toggle" id="menuToggle" aria-label="사이드바 열기/닫기">☰</button>

      <div class="dropdown" id="categoryDropdown" data-current="청년톡">
        <button class="pill dropdown-btn" id="dropdownBtn" aria-haspopup="true" aria-expanded="false">
          <span id="currentCategory">청년톡</span> ▾
        </button>

        <div class="dropdown-list" id="dropdownList">
          <div class="dropdown-item" data-cat="청년톡">청년톡</div>
          <div class="dropdown-item" data-cat="신혼부부톡 (I)">신혼부부톡 (I)</div>
          <div class="dropdown-item" data-cat="신혼부부톡 (II)">신혼부부톡 (II)</div>
        </div>

        <div class="hovercard" id="hoverCard"></div>
      </div>
    </div>

    <!-- Home -->
    <section class="home" id="homeView" aria-label="메인">
      <div class="hero">
        <h2>내 집 마련의 첫걸음, <em>Room Mate</em>가 함께합니다</h2>
        <p>청약부터 대출까지, 주거 고민은 Room Mate에게 맡겨보세요.</p>
        <form class="search" id="homeSearch" autocomplete="off">
          <input id="homeInput" type="text" placeholder="질문을 입력하세요" aria-label="질문을 입력하세요" />
        </form>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat" id="chatView" aria-label="채팅">
      <div class="chat-body" id="chatBody"></div>
      <div class="composer">
        <input class="input" id="composerInput" type="text" placeholder="질문을 입력하세요" />
      </div>
    </section>
  </main>
</div>

<!-- ===== Withdraw Modal ===== -->
<div class="modal-backdrop" id="withdrawModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="withdrawTitle">
    <div class="modal-header">
      <h3 id="withdrawTitle" style="margin:0;font-size:24px;font-weight:800">회원 탈퇴 전 안내</h3>
    </div>
    <div class="modal-body">
      <p style="font-size:18px;color:var(--muted)">지금까지 Room mate 서비스를 이용해 주셔서 정말 감사 드립니다. 더욱 개선된 서비스로 청년들에게 도움이 될 수 있도록 하겠습니다. 탈퇴하기 전 아래 유의사항을 확인해주세요.</p>
      <ul style="font-size:18px">
        <li>탈퇴하신 아이디는 <b>복구가 불가능</b>합니다.</li>
        <li>해당 사용자의 이메일 주소, 비밀번호와 지금까지 기록된 채팅 내역들이 삭제되며, <b>삭제된 데이터는 복구되지 않습니다.</b></li>
      </ul>
      <div class="modal-hl">확인 및 탈퇴하기</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="closeModal">닫기</button>
      <button class="btn btn-danger" id="confirmWithdraw">확인 및 탈퇴하기</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  회원 탈퇴가 완료되었습니다.
  <button id="toastOk">확인</button>
</div>

<script>
/*******************************
 * 0) Utilities & App State
 *******************************/
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const fmtTime = (d=new Date()) => d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
const API = (path) => `/api${path}`; // 동일 prefix

const state = {
  category: '청년톡',
  logs: [],                 // [{id,title,ts}]
  conversations: {},        // {id: [{role:'bot'|'me', text}]}
  activeId: null
};

/*******************************
 * 카테고리 설명 (hovercard)
 *******************************/
const CATEGORY_HELP = {
  '청년톡': `
    <h4>청년톡</h4>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당하는 미혼 청년</p>
    <ul>
      <li><b>만 19세 이상 만 39세 이하</b>인 사람</li>
      <li><b>대학생</b> (입학 및 복학 예정자 포함)</li>
      <li><b>취업준비생</b> (졸업·중퇴 2년 이내 미취업자)</li>
    </ul>`,
  '신혼부부톡 (I)': `
    <h4>신혼부부톡 (I)</h4>
    <p>전년도 도시근로자 가구당 월평균 소득 70% 이하(배우자 소득이 있는 경우 90% 이하) 충족, 국민임대주택 자산기준 충족</p>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p>
    <ul>
      <li><b>신혼부부</b> : 혼인 7년 이내</li>
      <li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li>
      <li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li>
      <li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li>
      <li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li>
      <li><b>혼인가구</b> : 혼인한 가구</li>
    </ul>`,
  '신혼부부톡 (II)': `
    <h4>신혼부부톡 (II)</h4>
    <p>무주택 요건 및 소득·자산 기준을 충족하고 다음 어느 하나에 해당</p>
    <ul>
      <li><b>신혼부부</b> : 혼인 7년 이내</li>
      <li><b>예비신혼부부</b> : 입주일 전일까지 혼인신고 예정</li>
      <li><b>한부모가족</b> : 만 6세 이하 자녀를 둔 한부모가족(또는 미성년 자녀를 둔 지원대상 한부모가족)</li>
      <li><b>유자녀 혼인가구</b> : 만 6세 이하 자녀가 있는 혼인가구</li>
      <li><b>신생아 가구</b> : 만 2세 이하 자녀가 있는 가구</li>
      <li><b>혼인가구</b> : 혼인한 가구</li>
    </ul>`,
};

/*******************************
 * 1) Renderers (DOM stays same)
 *******************************/
const homeView = $('#homeView');
const chatView = $('#chatView');
const chatBody = $('#chatBody');
const composer = $('#composerInput');

function renderLogs(){
  const wrap = $('#logList');
  wrap.innerHTML = '';
  if(state.logs.length===0){
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.style.padding = '4px 8px';
    empty.textContent = '채팅 기록이 없습니다';
    wrap.appendChild(empty);
    return;
  }
  state.logs.forEach(log=>{
    const el = document.createElement('div');
    el.className = 'log' + (state.activeId===log.id ? ' active' : '');
    el.dataset.id = log.id;
    el.innerHTML = `
      <div class="log-main">
        <div style="font-weight:700">${log.title}</div>
        <small>${log.ts || ''}</small>
      </div>
      <div class="log-actions" data-stop>
        <button class="kebab" data-kebab title="옵션">⋯</button>
        <div class="log-menu"><button data-delete>삭제</button></div>
      </div>`;

    el.addEventListener('click', (e)=>{
      if(e.target.closest('[data-stop]')) return; // 메뉴 클릭은 열기 막음
      openConversation(log.id);
    });
    wrap.appendChild(el);
  });
}

function renderConversation(id){
  const conv = state.conversations[id] || [];
  chatBody.innerHTML = '';
  conv.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'msg' + (m.sender==='user' ? ' me' : ''); 
    d.textContent = m.content; 
    d.style.marginTop = '14px';
    chatBody.appendChild(d);
  });
  chatBody.scrollTop = chatBody.scrollHeight; // 스크롤 맨 아래로
}

/*******************************
 * 2) View switches
 *******************************/
function goHome(){
  homeView.style.display = 'flex';
  chatView.classList.remove('active');
  state.activeId = null;
  renderLogs();
}
function openChat(id){
  homeView.style.display = 'none';
  chatView.classList.add('active');
  state.activeId = id;
  renderLogs();
  renderConversation(id);
  composer.focus();
}

/*******************************
 * 3) API wiring
 *******************************/
const csrftoken = document.querySelector('#csrf_form [name=csrfmiddlewaretoken]').value;

async function apiCall(url, data, method = 'POST') {
  try {
    const fetchOptions = {
      method: method,
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken 
      }
    };
    // GET 요청 시 body 제외
    if (method !== 'GET' && data) {
      fetchOptions.body = JSON.stringify(data);
    }
    
    const response = await fetch(url, fetchOptions);
    const result = await response.json();

    if (!response.ok) {
      alert(result.error || `오류가 발생했습니다. (HTTP ${response.status})`);
      return null;
    }
    return result;
  } catch (err) {
    alert('서버와 통신에 실패했습니다: ' + err);
    return null;
  }
}


// 3-1. 채팅로그 목록
// async function fetchLogs(){
//   const data = await apiJson(API('/conversations'));
//   // 기대 형태: [{id, title, ts}]
//   state.logs = data || [];
//   renderLogs();
// }

// 3-2. 특정 대화 메시지
async function fetchMessages(id){
  const result = await apiCall("{% url 'chat:api_get_chat_history' chat_id=0 %}".replace('0', id), null, 'GET'); 

  if (result && result.success) {
    state.conversations[id] = result.messages.map(msg => ({
        sender: msg.sender,
        content: msg.content 
    }));
    renderConversation(id);
  } else {
    state.conversations[id] = [];
    renderConversation(id);
  }
}

// 3-3. 새 채팅 생성 (초기 메시지 optional)
async function createNewChat(initialText=''){
  const result = await apiCall("{% url 'chat:api_create_new_chat' %}", {});
  if (result && result.success) {
    const newChatId = result.new_chat_id;
    const initialBotMessage = result.initial_message; // {content, sender:'bot'}

    const newLog = { 
        id: newChatId, 
        title: `새 채팅 (${state.category})`,
        ts: fmtTime() 
    };
    state.logs.unshift(newLog); 

    state.conversations[newChatId] = [{ sender: 'bot', content: initialBotMessage.content }]; 
    
    if(initialText) {
        state.conversations[newChatId].push({sender:'user', content: initialText});
        await sendMessage(newChatId, initialText); 
    }

    openChat(newChatId);
  }
}

// 3-4. 메시지 전송
async function sendMessage(id, text){
  const result = await apiCall("{% url 'chat:api_send_message' %}", { 
    chat_id: id, 
    message: text 
  }); 

  if (result && result.success) {
    const botMessage = result.bot_message;
    if(!state.conversations[id]) state.conversations[id] = []; 
    
    state.conversations[id].push({ sender: 'bot', content: botMessage.content }); 
    renderConversation(id);
  } else {
    // (전송 실패 처리 - apiCall이 alert 띄움)
  }
}

composer.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter' || e.isComposing) return;
  e.preventDefault();
  const val = composer.value.trim();
  if(!val || !state.activeId) return;

  if(!state.conversations[state.activeId]) state.conversations[state.activeId] = [];
  state.conversations[state.activeId].push({sender:'user', content: val});
  renderConversation(state.activeId);

  composer.value = ''; 
  await sendMessage(state.activeId, val);
});

// 3-5. 로그 삭제
async function deleteChat(id){
  const result = await apiCall("{% url 'chat:api_delete_chat' chat_id=0 %}".replace('0', id), null, 'DELETE'); 
  
  if (result && result.success) {
      state.logs = state.logs.filter(l=>l.id !== id);
      delete state.conversations[id];
      if(state.activeId === id){ goHome(); }
      renderLogs();
  }
  // (실패 시 apiCall이 alert 띄움)
}

// 3-6. 프로필
// async function fetchProfile(){
//   const me = await apiJson(API('/me'));
//   $('#emailText').textContent = me.email || '익명 사용자';
// }

// 3-7. 로그아웃 (앵커 가로채기)
// async function logout(){
//   await fetch(API('/logout'), { method:'POST' });
//   location.href = 'main.html';
// }

// 3-8. 회원탈퇴
async function withdraw(){
  const result = await apiCall("{% url 'user:api_withdraw_user' %}", {}); 
  
  if (result && result.success) {
      showToast(); 
      finalRedirectUrl = result.redirect_url; 
  }
  // (실패 시 apiCall이 alert 띄움)
}

// ----- 관련 이벤트 리스너 수정 -----
let finalRedirectUrl = "{% url 'user:index' %}";

$('#confirmWithdraw').addEventListener('click', async ()=>{
  await withdraw();
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
});

$('#toastOk').addEventListener('click', ()=> window.location.href = finalRedirectUrl );

/*******************************
 * 4) Events wiring (kept from chat.html)
 *******************************/
// 사이드바 토글
$('#menuToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('sidebar-closed');
});

// 로고 -> 홈
$('#logoBtn').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });

// 새 채팅 & 홈 검색
$('#newChatBtn').addEventListener('click', ()=> createNewChat(''));
$('#homeSearch').addEventListener('submit', (e)=>{
  e.preventDefault();
  const text = $('#homeInput').value.trim();
  if(text) createNewChat(text);
});

// 카테고리 드롭다운 + 호버카드
const dropdown = $('#categoryDropdown');
const dropdownBtn = $('#dropdownBtn');
const dropdownList = $('#dropdownList');
const hoverCard = $('#hoverCard');

dropdownBtn.addEventListener('click', ()=>{
  dropdown.classList.toggle('open');
  dropdownBtn.setAttribute('aria-expanded', dropdown.classList.contains('open'));
});
$$('.dropdown-item', dropdownList).forEach(item=>{
  item.addEventListener('click', ()=>{
    const cat = item.getAttribute('data-cat');
    state.category = cat.replace(/ \(.+\)$/,'') === '신혼부부톡' ? '신혼부부톡' : cat;
    $('#currentCategory').textContent = cat;
    dropdown.classList.remove('open','show-card');
    dropdownBtn.setAttribute('aria-expanded','false');
  });
  item.addEventListener('mouseenter', (e)=>{
    const key = e.target.getAttribute('data-cat');
    hoverCard.innerHTML = CATEGORY_HELP[key] || '';
    dropdown.classList.add('show-card');
  });
});

dropdown.addEventListener('mouseleave', ()=> dropdown.classList.remove('show-card'));

// 이메일 메뉴 (모바일 클릭 토글)
const accountWrap = $('#accountWrap');
const emailArea = $('#emailArea');
const accountMenu = $('#accountMenu');

authWire();

function authWire(){
  // 클릭 토글 (데스크톱 호버는 CSS)
  emailArea.addEventListener('click', (e)=>{
    e.stopPropagation();
    accountMenu.classList.toggle('open');
    emailArea.setAttribute('aria-expanded', accountMenu.classList.contains('open') ? 'true' : 'false');
  });
  document.addEventListener('click', (e)=>{
    if(!accountWrap.contains(e.target)){
      accountMenu.classList.remove('open');
      emailArea.setAttribute('aria-expanded','false');
    }
  });
  // 로그아웃 링크 가로채기 -> API 호출 후 리다이렉트
  // const logoutLink = $("#accountMenu a[href='main.html']");
  // if(logoutLink){
  //   logoutLink.addEventListener('click', async (e)=>{ e.preventDefault(); await logout(); });
  // }
}

// 로그 목록 내 옵션(⋯) & 삭제
const logList = $('#logList');
logList.addEventListener('click', async (e)=>{
  const item = e.target.closest('.log');
  if(!item) return;
  const kebab = e.target.closest('[data-kebab]');
  if(kebab){ e.stopPropagation(); item.classList.toggle('open'); return; }
  const delBtn = e.target.closest('[data-delete]');
  if(delBtn){ e.stopPropagation(); await deleteChat(item.dataset.id); return; }
});

// 채팅 입력 -> API 전송
composer.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  const val = composer.value.trim();
  if(!val || !state.activeId) return;
  composer.value = '';
  await sendMessage(state.activeId, val);
});

// 기존 채팅 열기 -> 메시지 로드
async function openConversation(id){
  openChat(id);
  await fetchMessages(id);
}

// 회원탈퇴 모달 + 토스트
const modal = $('#withdrawModal');
$('#openWithdraw').addEventListener('click', ()=>{
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
});
$('#closeModal').addEventListener('click', ()=>{
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
});
$('#confirmWithdraw').addEventListener('click', async ()=>{
  try{
    await withdraw();
  }finally{
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
});
const toast = $('#toast');
function showToast(){ toast.style.display = 'block'; }
$('#toastOk').addEventListener('click', ()=> window.location.href = 'main.html');

/*******************************
 * 5) Boot
 *******************************/
function boot(){
  if (window.matchMedia('(max-width: 980px)').matches) {
    document.body.classList.add('sidebar-closed');
  }
  
  state.logs = [
    {% for chat in chat_history %}
      { 
        id: {{ chat.id }}, 
        title: "{{ chat.title|default:'Untitled Chat'|escapejs }}",
        ts: "{{ chat.created_at|date:'Y.m.d H:i'|escapejs }}"
      },
    {% empty %}
      // 채팅 기록이 없을 경우 state.logs는 빈 배열 유지
    {% endfor %}
  ];
  
  $('#emailText').textContent = "{{ user_email|escapejs }}";

`renderLogs();
}
boot();

</script>

<script>
// --- 사이드바 로그: kebab 메뉴 & 삭제 위임 (패치 추가) ---
(() => {
  const wrap = document.querySelector('#logList');
  if (!wrap) return;

  // 문서 클릭시 열린 메뉴 닫기
  document.addEventListener('click', () => {
    document.querySelectorAll('#logList .log.open').forEach(el => el.classList.remove('open'));
  });

  wrap.addEventListener('click', async (e) => {
    const logItem = e.target.closest('.log');
    if (!logItem) return;
    const id = logItem.dataset.id;

    // kebab(⋯) 토글
    if (e.target.closest('[data-kebab]')) {
      e.stopPropagation();
      // 다른 열린 메뉴 닫기
      wrap.querySelectorAll('.log.open').forEach(el => { if (el !== logItem) el.classList.remove('open'); });
      logItem.classList.toggle('open');
      return;
    }

    // 삭제 버튼
    if (e.target.closest('[data-delete]')) {
      e.stopPropagation();
      logItem.classList.remove('open');
      try {
        await deleteChat(id);
      } catch (err) {
        alert('삭제에 실패했습니다. 잠시 후 다시 시도해 주세요.');
      }
      return;
    }
  });
})();
</script>
</body>
</html>
