<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Mate – 회원가입 (1·2·3단계 통합)</title>
<style>
  :root{
    --line:#e5e7eb; --muted:#9ca3af; --text:#111827; --btn:#7a7a7a;
    --link:#6c79ff; --ok:#10b981; --warn:#ef4444;
    --shadow:0 2px 10px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.05);
    --overlay:rgba(17,24,39,.55); --panel:#fff; --accent:#8b7cf6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:#fff}

  /* 상단 바 */
  .topbar{height:56px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 22px}
  .logo{font-family:"Times New Roman", Georgia, "Noto Serif KR", serif;font-style:italic;font-size:22px;text-decoration:none;color:var(--text)}
  .logo:hover{text-decoration:underline}
  .toplink{color:var(--text);text-decoration:none;font-size:14px}

  /* 공통 레이아웃 */
  .wrap{min-height:calc(100vh - 56px);padding:6vh 16px 10vh}
  .container{width:min(920px,94vw);margin:0 auto}
  .title{text-align:center;font-size:34px;font-weight:700;margin:36px 0 24px}

  /* 단계 표시 */
  .steps{display:flex;gap:36px;justify-content:center;align-items:center;margin:8px 0 36px}
  .step{display:flex;align-items:center;gap:12px;font-size:14px;color:#c2c9d3;user-select:none}
  .step.clickable{cursor:pointer}
  .dot{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#f7f7f8;color:#b8bec8;border:1px solid #eceff3;font-weight:700}
  .active{color:var(--text);font-weight:700}
  .active .dot{background:#111827;color:#fff;border-color:#111827}

  /* 1단계 카드 */
  .card{border:1px solid var(--line);border-radius:10px;background:#fff;padding:18px;margin:0 auto;width:min(820px,96vw)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 6px}
  .row + .row{border-top:1px solid var(--line)}
  .label{display:flex;align-items:center;gap:10px}
  .req{color:#6b72ff;font-weight:700}
  .btn-ghost{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}

  /* 2단계: 이메일 입력/인증 */
  .section{width:min(620px,94vw);margin:0 auto 34px}
  .label-strong{font-weight:600;margin:22px 0 6px}
  .help{font-size:13px;color:#777;margin:0 0 16px}
  .row2{display:flex;gap:8px;align-items:center}
  input[type=email], .code{flex:1;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:#fafafa;font-size:15px}
  input[type=email]:focus, .code:focus{outline:none;border-color:#aab4ff;box-shadow:0 0 0 3px rgba(124,140,248,.2);background:#fff}
  .btn{border:0;background:var(--btn);color:#fff;font-weight:600;cursor:pointer}
  .btn-send,.btn-confirm{padding:12px 18px;border-radius:10px}
  .btn:hover{filter:brightness(1.05)}
  .timer{margin-left:10px;font-size:13px;color:#ef4444}
  .subtle{font-size:12px;color:#8b8b8b;margin-top:8px}
  .subtle a{color:var(--link);text-decoration:none}

  /* 3단계: 비밀번호 설정 */
  .field{margin:22px auto;width:min(620px,94vw)}
  .label-3{font-weight:600;margin:4px 0 8px}
  .control{position:relative;}
  .input{width:100%;padding:14px 16px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-size:15px;}
  .input:focus{outline:none;border-color:#aab4ff;box-shadow:0 0 0 3px rgba(124,140,248,.2);background:#fff}
  .toggle{position:absolute;right:10px;top:8px;padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;}
  .msg{font-size:13px;margin-top:6px}
  .msg.ok{color:var(--ok)} .msg.warn{color:var(--warn)}

  /* 공통 액션 버튼 */
  .actions{display:flex;justify-content:center;margin-top:28px}
  .btn-next{width:240px;height:52px;border-radius:16px;box-shadow:var(--shadow)}
  .btn-next:disabled{opacity:.45;cursor:not-allowed}

  .hidden{display:none}

  /* ===== 모달 ===== */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay);z-index:50;padding:24px;}
  .overlay.show{display:flex;}
  .modal{width:min(820px,96vw);max-height:min(80vh,900px);background:var(--panel);border-radius:14px;box-shadow:0 20px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;border:1px solid var(--line);}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .modal-title{font-weight:700}
  .modal-body{padding:14px 16px}
  .terms-box{height:56vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:16px;white-space:pre-wrap;line-height:1.55;background:#fafafa;}
  .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}
  .btn-close{background:#fff;color:#111;border:1px solid var(--line);border-radius:10px;padding:10px 16px;cursor:pointer}
  .btn-primary{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 16px;cursor:pointer}
</style>
</head>


<body>
  <form id="csrf_form" style="display: none;">{% csrf_token %}</form>

  <header class="topbar">
    <!-- 요구1: 로고 클릭 시 intro.html -->
    <a class="logo" href="{% url 'user:index' %}" title="Intro로 이동">Room Mate</a>
    <a class="toplink" href="{% url 'user:login' %}">로그인</a>
  </header>

  <main class="wrap">
    <div class="container">
      <h1 class="title">회원가입</h1>

      <!-- 단계표시 (뒤로 가기용 클릭 허용) -->
      <div class="steps" aria-label="회원가입 단계">
        <div class="step clickable active" id="step1Indicator" data-step="1"><span class="dot">1</span><span>개인정보 약관 동의</span></div>
        <div class="step clickable" id="step2Indicator" data-step="2"><span class="dot">2</span><span>개인정보 입력</span></div>
        <div class="step clickable" id="step3Indicator" data-step="3"><span class="dot">3</span><span>비밀번호 설정</span></div>
      </div>

      <!-- ===== 1단계: 약관 동의 ===== -->
      <section id="step1">
        <div class="card">
          <div class="row">
            <label class="label"><input id="all" type="checkbox" /><span>전체 약관 동의</span></label>
          </div>
          <div class="row">
            <label class="label" for="tos"><input id="tos" type="checkbox" /><span><span class="req">[필수]</span> 이용약관</span></label>
            <button id="btnTosView" class="btn-ghost" type="button" aria-haspopup="dialog" aria-controls="tosModal">내용 보기</button>
          </div>
          <div class="row">
            <label class="label" for="privacy"><input id="privacy" type="checkbox" /><span><span class="req">[필수]</span> 개인정보 수집 및 이용 동의</span></label>
            <button id="btnPrivacyView" class="btn-ghost" type="button" aria-haspopup="dialog" aria-controls="privacyModal">내용 보기</button>
          </div>
        </div>
        <div class="actions">
          <button id="btnToStep2" class="btn btn-next" disabled>다음</button>
        </div>
      </section>

      <!-- ===== 2단계: 이메일 입력/인증 ===== -->
      <section id="step2" class="hidden">
        <div class="section">
          <div class="label-strong">이메일 입력</div>
          <p class="help">회원가입 시 사용할 본인 이메일을 입력해주세요</p>
          <label class="label-strong" for="email">이메일 (e.g. email@gmail.com)</label>
          <div class="row2">
            <input type="email" id="email" placeholder="이메일을 입력하세요" required />
            <button type="button" class="btn btn-send" id="btnSend">전송</button>
          </div>
        </div>

        <div class="section hidden" id="verifyBox">
          <div class="label-strong">이메일 인증</div>
          <p class="help">해당 이메일로 전송된 검증 코드를 입력해주세요</p>
          <div class="row2">
            <input class="code" id="code" inputmode="numeric" maxlength="11" placeholder="XXXX - XXXX" />
            <span class="timer" id="timer">3:00</span>
            <button type="button" class="btn btn-confirm" id="btnCheck">확인</button>
          </div>
          <p class="subtle">검증 코드가 보내지지 않았나요? <a href="#" id="resend">재전송</a></p>
        </div>

        <div class="actions">
          <button class="btn btn-next" id="btnNextStep2" disabled>다음</button>
        </div>
      </section>

      <!-- ===== 3단계: 비밀번호 설정 ===== -->
      <section id="step3" class="hidden">
        <div class="field">
          <div class="label-3">비밀번호 (8 ~ 16자, 영문 대소문자/숫자/특수문자 포함)</div>
          <div class="control">
            <input id="pw" class="input" type="password" placeholder="비밀번호 입력" autocomplete="new-password" />
            <button type="button" class="toggle" data-target="pw">Hide</button>
          </div>
          <div id="pwMsg" class="msg"></div>
        </div>

        <div class="field">
          <div class="label-3">비밀번호 재입력</div>
          <div class="control">
            <input id="pw2" class="input" type="password" placeholder="비밀번호 재입력" autocomplete="new-password" />
            <button type="button" class="toggle" data-target="pw2">Hide</button>
          </div>
          <div id="matchMsg" class="msg"></div>
        </div>

        <div class="actions">
          <button id="nextBtn" class="btn btn-next" disabled>다음</button>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== 이용약관 모달 ===== -->
  <div id="tosModal" class="overlay" role="dialog" aria-modal="true" aria-labelledby="tosTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="tosTitle" class="modal-title">이용약관</div>
        <button type="button" class="btn-close" id="tosCloseTop" aria-label="닫기">닫기</button>
      </div>
      <div class="modal-body">
        <div class="terms-box" id="tosContent">
RoomMate 이용약관

제1조 (목적)
이 약관은 룸메이트(이하 "서비스 제공자"라 함)이 제공하는 RoomMate(이하 "서비스"라 함)의 이용과 관련하여 "서비스 제공자"와 "회원" 간의 권리, 의무 및 책임사항, 기타 필요한 사항을 규정함을 목적으로 합니다.

제2조 (용어의 정의)
이 약관에서 사용하는 용어의 정의는 다음과 같습니다.
1. "서비스": 청년과 신혼부부를 위한 주택청약 도우미 챗봇 서비스를 의미합니다.
2. "회원": "서비스 제공자"의 "서비스"에 접속하여 이 약관에 따라 "서비스 제공자"와 이용계약을 체결하고 "서비스 제공자"가 제공하는 "서비스"를 이용하는 고객을 말합니다.
3. "계정(이메일 주소)": "회원"의 식별과 "서비스" 이용을 위하여 "회원"이 제공한 이메일 주소를 의미합니다.
4. "비밀번호": "회원"이 부여받은 "계정(이메일 주소)"와 일치되는 "회원"임을 확인하고 비밀보호를 위해 "회원" 자신이 정한 문자 또는 숫자의 조합을 의미합니다.
5. "게시물": "회원"이 "서비스"를 이용함에 있어 "서비스" 상에 게시한 부호·문자·음성·화상·동영상 등의 정보 형태의 글, 사진, 동영상 및 각종 파일과 링크 등을 의미합니다.

제3조 (약관의 게시와 개정)
1.  "서비스 제공자"는 이 약관의 내용을 "회원"이 쉽게 알 수 있도록 서비스 초기 화면에 게시합니다.
2.  "서비스 제공자"는 "약관의 규제에 관한 법률", "정보통신망 이용촉진 및 정보보호 등에 관한 법률" 등 관련 법을 위배하지 않는 범위에서 이 약관을 개정할 수 있습니다.
3.  "서비스 제공자"가 약관을 개정할 경우에는 적용일자 및 개정 사유를 명시하여 현행약관과 함께 제1항의 방식에 따라 그 개정약관의 적용일자 [예: 7일]일 전부터 적용일자 전일까지 공지합니다. 다만, 회원에게 불리한 약관의 개정의 경우에는 그 적용일자 [예: 30일]일 전부터 공지하며, 이메일 등으로 "회원"에게 개별 통지할 수 있습니다.
4.  "회원"이 개정약관의 적용에 동의하지 않는 경우 "회원"은 이용계약을 해지할 수 있습니다.

제4조 (회원가입)
1.  회원가입은 "서비스"를 이용하려는 자(이하 "가입신청자")가 약관의 내용에 대하여 동의를 한 다음 회원가입신청을 하고, "서비스 제공자"가 이러한 신청에 대하여 승낙함으로써 체결됩니다.
2.  "서비스 제공자"는 다음 각 호에 해당하는 신청에 대하여는 승낙을 하지 않거나 사후에 이용계약을 해지할 수 있습니다.
    * 가입신청자가 이전에 회원자격을 상실한 적이 있는 경우
    * 실명이 아니거나 타인의 명의를 이용한 경우
    * 허위의 정보를 기재하거나, "서비스 제공자"가 제시하는 내용을 기재하지 않은 경우
    * 기타 "서비스 제공자"가 정한 이용신청 요건이 미비되었을 때

제5조 (회원정보의 변경)
1.  "회원"은 개인정보관리화면을 통하여 언제든지 본인의 개인정보를 열람하고 수정할 수 있습니다.
2.  "회원"은 회원가입신청 시 기재한 사항이 변경되었을 경우 온라인으로 수정을 하거나 전자우편 기타 방법으로 "서비스 제공자"에 대하여 그 변경사항을 알려야 합니다.
3.  제2항의 변경사항을 "서비스 제공자"에 알리지 않아 발생한 불이익에 대하여 "서비스 제공자"는 책임지지 않습니다.

제6조 ("회원"의 "계정(이메일 주소)" 및 "비밀번호"의 관리에 대한 의무)
1.  "회원"의 "계정(이메일 주소)"와 "비밀번호"에 관한 관리책임은 "회원"에게 있으며, 이를 제3자가 이용하도록 하여서는 안 됩니다.
2.  "회원"은 "계정(이메일 주소)" 및 "비밀번호"가 도용되거나 제3자가 사용하고 있음을 인지한 경우에는 이를 즉시 "서비스 제공자"에 통지하고 "서비스 제공자"의 안내에 따라야 합니다.

제7조 ("서비스 제공자"의 의무)
1.  "서비스 제공자"는 관련 법령과 이 약관이 금지하거나 미풍양속에 반하는 행위를 하지 않으며, 계속적이고 안정적으로 "서비스"를 제공하기 위하여 최선을 다하여 노력합니다.
2.  "서비스 제공자"는 "회원"이 안전하게 "서비스"를 이용할 수 있도록 개인정보(신용정보 포함) 보호를 위한 보안 시스템을 갖추어야 하며, 개인정보처리방침을 공시하고 준수합니다.

제8조 ("회원"의 의무)
1.  "회원"은 다음 행위를 하여서는 안 됩니다.
    * 신청 또는 변경 시 허위 내용의 등록
    * 타인의 정보 도용
    * "서비스 제공자"가 게시한 정보의 변경
    * "서비스 제공자"가 정한 정보 이외의 정보(컴퓨터 프로그램 등) 등의 송신 또는 게시
    * "서비스 제공자"와 기타 제3자의 저작권 등 지적재산권에 대한 침해
    * "서비스 제공자" 및 기타 제3자의 명예를 손상시키거나 업무를 방해하는 행위
    * 외설 또는 폭력적인 메시지, 화상, 음성, 기타 공서양속에 반하는 정보를 "서비스"에 공개 또는 게시하는 행위

제9조 (서비스의 제공 및 변경)
1.  "서비스 제공자"는 "회원"에게 다음과 같은 "서비스"를 제공합니다.
    * 사용자 맞춤형 공고 추천 챗봇
    * 주거지원정책, 주택청약 기본정보 단계 지원 챗봇
    * 사용자 조건에 맞는 청년 대출 추천 챗봇
2.  "서비스 제공자"는 상당한 이유가 있는 경우에 운영상, 기술상의 필요에 따라 제공하고 있는 전부 또는 일부 "서비스"를 변경할 수 있습니다.
3.  "서비스"의 내용, 이용방법, 이용 시간에 대하여 변경이 있는 경우에는 변경사유, 변경될 서비스의 내용 및 제공일자 등은 그 변경 전 7일 이상 해당 서비스 초기화면에 게시하여야 합니다.

제10조 (계약 해제, 해지 등)
1.  "회원"은 언제든지 "서비스" 내 '회원 탈퇴' 메뉴를 통하여 이용계약 해지 신청을 할 수 있으며, "서비스 제공자"는 관련 법령 등이 정하는 바에 따라 이를 즉시 처리하여야 합니다.
2.  "회원"이 제8조의 의무를 위반한 경우, "서비스 제공자"는 사전통보 없이 이용계약을 해지하거나 또는 기간을 정하여 서비스 이용을 제한할 수 있습니다.

제11조 (면책조항)
1.  "서비스 제공자"는 천재지변 또는 이에 준하는 불가항력으로 인하여 "서비스"를 제공할 수 없는 경우에는 "서비스" 제공에 관한 책임이 면제됩니다.
2.  "서비스 제공자"는 "회원"의 귀책사유로 인한 "서비스" 이용의 장애에 대하여는 책임을 지지 않습니다.
3.  "서비스 제공자"는 "회원"이 "서비스"와 관련하여 게재한 정보, 자료, 사실의 신뢰도, 정확성 등의 내용에 관하여는 책임을 지지 않습니다.

제12조 (분쟁 해결)
1.  "서비스 제공자"와 "회원" 간 제기된 소송은 대한민국법을 준거법으로 합니다.
2.  "서비스 제공자"와 "회원" 간 발생한 분쟁에 관한 소송은 [관할 법원, 예: 서울중앙지방법원]을 관할법원으로 합니다.

---

**부칙**
제1조 (시행일) 이 약관은 [시행일, 예: 2025년 10월 27일]부터 시행합니다
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-close" id="tosClose">닫기</button>
        <button type="button" class="btn-primary" id="tosAgree">동의합니다</button>
      </div>
    </div>
  </div>

  <!-- ===== 개인정보 수집·이용 동의 모달 ===== -->
  <div id="privacyModal" class="overlay" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="privacyTitle" class="modal-title">개인정보 수집 및 이용 동의</div>
        <button type="button" class="btn-close" id="privacyCloseTop" aria-label="닫기">닫기</button>
      </div>
      <div class="modal-body">
        <div class="terms-box" id="privacyContent">
RoomMate은(는)「개인정보 보호법」등 관련 법령에 따라, 서비스 회원가입을 위해 아래와 같이 개인정보를 수집·이용합니다. 내용을 자세히 읽으신 후 동의 여부를 결정해 주시기 바랍니다.

[필수] 개인정보 수집 및 이용 동의
- 수집 목적 : 회원 식별, 서비스 제공
- 수집 항목 : 이메일 주소, 비밀번호
- 보유 기간 : 보유 기간 : 회원 탈퇴 시까지 보유. 단, 「통신비밀보호법」 등 관련 법령의 규정에 따라 보존할 필요가 있는 경우, 해당 법령에서 정한 기간 동안 보관 후 파기

귀하는 위와 같은 개인정보 수집·이용에 대한 동의를 거부할 권리가 있습니다. 그러나 동의를 거부할 경우, RoomMate 회원가입이 제한되어 서비스 이용이 불가능합니다.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-close" id="privacyClose">닫기</button>
        <button type="button" class="btn-primary" id="privacyAgree">동의합니다</button>
      </div>
    </div>
  </div>

<script>
  /* ---------- 상태/참조 ---------- */
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const step1Indicator = document.getElementById('step1Indicator');
  const step2Indicator = document.getElementById('step2Indicator');
  const step3Indicator = document.getElementById('step3Indicator');
  const sections = {1:step1, 2:step2, 3:step3};
  const indicators = {1:step1Indicator, 2:step2Indicator, 3:step3Indicator};
  let currentStep = 1; // 현재 단계

  function setActive(step){
    Object.values(indicators).forEach(el=>el.classList.remove('active'));
    indicators[step].classList.add('active');
  }
  function showStep(step){
    // 섹션 보이기/숨기기 (입력값은 DOM에 남아 보존됨)
    [1,2,3].forEach(n=>sections[n].classList.toggle('hidden', n!==step));
    setActive(step);
    currentStep = step;
  }

  /* ---------- 1단계(약관) ---------- */
  const all = document.getElementById('all');
  const tos = document.getElementById('tos');
  const privacy = document.getElementById('privacy');
  const btnToStep2 = document.getElementById('btnToStep2');

  function updateAgreementState(){
    const ok = tos.checked && privacy.checked;
    btnToStep2.disabled = !ok;
    all.checked = ok;
  }
  all.addEventListener('change', ()=>{ tos.checked = all.checked; privacy.checked = all.checked; updateAgreementState(); });
  [tos, privacy].forEach(el => el.addEventListener('change', updateAgreementState));
  updateAgreementState();

  btnToStep2.addEventListener('click', ()=>{
    showStep(2); // 1 → 2는 '다음'으로만
    document.getElementById('email').focus();
  });

  const csrftoken = document.querySelector('#csrf_form [name=csrfmiddlewaretoken]').value;

  async function apiCall(url, data) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (!response.ok) { // 4xx, 5xx 에러
        alert(result.error || '오류가 발생했습니다.'); // views.py의 {error: '...'}
        return null;
      }
      return result; // views.py의 {message: '...'} 또는 {verified: true}
    } catch (err) {
      alert('서버와 통신에 실패했습니다: ' + err);
      return null;
    }
  }

  /* ---------- 2단계(이메일 입력/인증) ---------- */
  const emailEl = document.getElementById('email');
  const btnSend = document.getElementById('btnSend');
  const verifyBox = document.getElementById('verifyBox');
  const codeEl = document.getElementById('code');
  const btnCheck = document.getElementById('btnCheck');
  const btnNextStep2 = document.getElementById('btnNextStep2');
  const timerEl = document.getElementById('timer');
  const resend = document.getElementById('resend');

  let timerId = null;
  let remain = 180;
  let verified = false;

  function formatTime(s){ const m=Math.floor(s/60); const sec=String(s%60).padStart(2,'0'); return `${m}:${sec}`; }
  function startTimer(){
    clearInterval(timerId); remain = 180; timerEl.textContent = formatTime(remain);
    timerId = setInterval(()=>{
      remain--;
      if(remain <= 0){ clearInterval(timerId); remain = 0; timerEl.textContent = '0:00'; btnNextStep2.disabled = true; }
      else { timerEl.textContent = formatTime(remain); }
    }, 1000);
  }


  btnSend.addEventListener('click', async () => {
    const email = emailEl.value.trim();
    if(!email){ alert('이메일을 입력해주세요.'); return; }
    
    btnSend.disabled = true;
    const result = await apiCall("{% url 'user:api_send_sign_code' %}", { email: email });
    btnSend.disabled = false;

    if (result) {
      alert('인증코드를 ' + email + ' 로 전송했습니다.');
      verifyBox.classList.remove('hidden');
      verified = false; btnNextStep2.disabled = true;
      startTimer(); codeEl.value=''; codeEl.focus();
    }
  });

  resend.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = emailEl.value.trim();
    if(!email){ alert('이메일을 먼저 입력해주세요.'); return; }

    const result = await apiCall("{% url 'user:api_send_sign_code' %}", { email: email });

    if (result) {
      alert('인증코드를 재전송했습니다.');
      verified = false; btnNextStep2.disabled = true; 
      startTimer(); codeEl.value=''; codeEl.focus();
  }
  });

  codeEl.addEventListener('input', ()=>{
    let v = codeEl.value.replace(/[^a-zA-Z]/g, '');
    codeEl.value = v.slice(0, 8);
  });
  codeEl.placeholder = "영문 8자리";
  codeEl.inputmode = "text";

  btnCheck.addEventListener('click', async ()=>{ 
    const code = codeEl.value.trim();
    if(remain === 0){ alert('시간이 만료되었습니다. 코드를 재전송 해주세요.'); return; }
    if(code.length !== 8){ alert('8자리 영문 코드를 입력하세요.'); return; }

    btnCheck.disabled = true;
    const result = await apiCall("{% url 'user:api_verify_sign_code' %}", { code: code });
    btnCheck.disabled = false;

    if (result && result.verified) {
        verified = true;
        alert('이메일 인증이 완료되었습니다.'); 
        btnNextStep2.disabled = false;
        clearInterval(timerId);
    }
  });

  // 2 → 3 는 '다음'으로만
  btnNextStep2.addEventListener('click', ()=>{
    if(!verified){ alert('이메일 인증을 완료하세요.'); return; }
    showStep(3);
    document.getElementById('pw').focus();
  });

  /* ---------- 3단계(비밀번호 설정) ---------- */
  const pw = document.getElementById('pw');
  const pw2 = document.getElementById('pw2');
  const nextBtn = document.getElementById('nextBtn');
  const pwMsg = document.getElementById('pwMsg');
  const matchMsg = document.getElementById('matchMsg');

  const reLen=/^.{8,16}$/; const reUpper=/[A-Z]/; const reLower=/[a-z]/; const reNum=/[0-9]/; const reSpec=/[^A-Za-z0-9]/;
  function validPassword(v){ return reLen.test(v)&&reUpper.test(v)&&reLower.test(v)&&reNum.test(v)&&reSpec.test(v); }

  function renderPw(){
    const v1=pw.value, v2=pw2.value;
    if(!v1){ pwMsg.textContent=''; pwMsg.className='msg'; }
    else if(validPassword(v1)){ pwMsg.textContent='사용 가능한 비밀번호입니다.'; pwMsg.className='msg ok'; }
    else { pwMsg.textContent='8~16자, 대/소문자·숫자·특수문자 각각 1개 이상 포함해야 합니다.'; pwMsg.className='msg warn'; }

    if(!v2){ matchMsg.textContent=''; matchMsg.className='msg'; }
    else if(v1===v2){ matchMsg.textContent='비밀번호가 일치합니다.'; matchMsg.className='msg ok'; }
    else { matchMsg.textContent='비밀번호가 일치하지 않습니다.'; matchMsg.className='msg warn'; }

    nextBtn.disabled = !(validPassword(v1) && v1===v2);
  }
  pw.addEventListener('input', renderPw);
  pw2.addEventListener('input', renderPw);

  document.querySelectorAll('.toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input = document.getElementById(btn.dataset.target);
      if(input.type==='password'){ input.type='text'; btn.textContent='Show'; }
      else { input.type='password'; btn.textContent='Hide'; }
      input.focus(); const val=input.value; input.value=''; input.value=val;
    });
  });

  nextBtn.addEventListener('click', async ()=>{
    const password = pw.value;
    nextBtn.disabled = true;
    const result = await apiCall("{% url 'user:api_create_user' %}", { password: password });
    if (result && result.created) {
      alert('회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.');
      location.href = result.redirect_url;
    } else {
      nextBtn.disabled = false;
    }
  });

  /* ---------- 단계 인디케이터: 뒤로 가기만 허용 ---------- */
  function backTo(step){
    // 현재 단계보다 작은 step만 허용 (뒤로가기)
    if(step < currentStep){
      showStep(step);
      // 버튼 상태 갱신(뒤로 가도 규칙 유지)
      updateAgreementState();
      renderPw();
    }
  }
  step1Indicator.addEventListener('click', ()=>backTo(1));
  step2Indicator.addEventListener('click', ()=>backTo(2));
  step3Indicator.addEventListener('click', ()=>backTo(3)); // 동일 클릭 시 무시

  /* ---------- 공통 모달 유틸 ---------- */
  function openModal(modalEl, triggerBtn){
    modalEl.classList.add('show');
    modalEl._trigger = triggerBtn;
    const escHandler = (e)=>{ if(e.key==='Escape'){ closeModal(modalEl); } };
    modalEl._escHandler = escHandler;
    document.addEventListener('keydown', escHandler);
  }
  function closeModal(modalEl){
    modalEl.classList.remove('show');
    if(modalEl._escHandler){ document.removeEventListener('keydown', modalEl._escHandler); modalEl._escHandler=null; }
    modalEl._trigger?.focus();
  }

  /* ---------- 이용약관 모달 ---------- */
  const btnTosView = document.getElementById('btnTosView');
  const tosModal = document.getElementById('tosModal');
  const tosClose = document.getElementById('tosClose');
  const tosCloseTop = document.getElementById('tosCloseTop');
  const tosAgree = document.getElementById('tosAgree');

  btnTosView.addEventListener('click', ()=>openModal(tosModal, btnTosView));
  tosClose.addEventListener('click', ()=>closeModal(tosModal));
  tosCloseTop.addEventListener('click', ()=>closeModal(tosModal));
  tosAgree.addEventListener('click', ()=>{
    document.getElementById('tos').checked = true;
    updateAgreementState();
    closeModal(tosModal);
  });
  tosModal.addEventListener('click', (e)=>{ if(e.target === tosModal) closeModal(tosModal); });

  /* ---------- 개인정보 모달 ---------- */
  const btnPrivacyView = document.getElementById('btnPrivacyView');
  const privacyModal = document.getElementById('privacyModal');
  const privacyClose = document.getElementById('privacyClose');
  const privacyCloseTop = document.getElementById('privacyCloseTop');
  const privacyAgree = document.getElementById('privacyAgree');

  btnPrivacyView.addEventListener('click', ()=>openModal(privacyModal, btnPrivacyView));
  privacyClose.addEventListener('click', ()=>closeModal(privacyModal));
  privacyCloseTop.addEventListener('click', ()=>closeModal(privacyModal));
  privacyAgree.addEventListener('click', ()=>{
    document.getElementById('privacy').checked = true;
    updateAgreementState();
    closeModal(privacyModal);
  });
  privacyModal.addEventListener('click', (e)=>{ if(e.target === privacyModal) closeModal(privacyModal); });
</script>
</body>
</html>
