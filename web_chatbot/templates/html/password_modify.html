<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Mate – 비밀번호 수정 (통합)</title>
<style>
  :root{ --line:#e5e7eb; --muted:#9ca3af; --text:#111827; --btn:#7a7a7a;
         --shadow:0 2px 10px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.05); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:#fff}

  /* 헤더 */
  .topbar{height:56px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 22px}
  .logo{font-family:"Times New Roman",serif;font-style:italic;font-size:22px;color:var(--text);text-decoration:none}
  .toplink{color:var(--text);text-decoration:none;font-size:14px}

  /* 레이아웃 */
  .wrap{min-height:calc(100vh - 56px);padding:6vh 16px 10vh}
  .container{width:min(820px,94vw);margin:0 auto}
  .title{text-align:center;font-size:32px;font-weight:700;margin:36px 0 24px}

  /* 단계 표시 */
  .steps{display:flex;gap:36px;justify-content:center;align-items:center;margin:8px 0 36px}
  .step{display:flex;align-items:center;gap:12px;font-size:14px;color:#c2c9d3}
  .step.clickable{cursor:pointer}  /* ← 2단계에 있을 때만 1번을 클릭 가능 */
  .dot{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#f7f7f8;color:#b8bec8;border:1px solid #eceff3;font-weight:700}
  .active{color:var(--text);font-weight:700}
  .active .dot{background:#111827;color:#fff;border-color:#111827}

  /* 공통 폼 */
  .section{width:min(680px,94vw);margin:0 auto}
  .label-strong{font-weight:700;margin:22px 0 6px}
  .help{font-size:13px;color:#777;margin:0 0 16px}
  input[type=email], input[type=text], input[type=password]{
    width:100%;padding:16px 16px;border-radius:12px;border:1px solid var(--line);background:#fafafa;font-size:15px
  }
  input:focus{outline:none;border-color:#aab4ff;box-shadow:0 0 0 3px rgba(124,140,248,.2);background:#fff}

  .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;margin-bottom:28px}
  .input-wrap{position:relative}
  .actions{display:flex;justify-content:center;margin-top:8px}
  .btn{border:0;background:var(--btn);color:#fff;font-weight:600;cursor:pointer}
  .btn-slim{height:52px;padding:0 18px;border-radius:12px}
  .btn-next{width:260px;height:56px;border-radius:16px;box-shadow:var(--shadow)}
  .btn-next:disabled{opacity:.45;cursor:not-allowed}

  /* 1단계: 코드 입력 스타일 */
  #code{ text-align:center; letter-spacing:2px; font-size:18px; font-weight:500; transition:text-align .2s ease }
  #code:focus{ text-align:left }
  .timer{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#ef4444;font-size:13px}
  .resend{color:#8b8b8b;font-size:13px;margin:6px 0 28px}
  .resend a{color:#666;text-decoration:underline;cursor:pointer}

  /* 2단계: 토글 버튼 */
  .toggle-btn{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    color:#666;font-size:13px;cursor:pointer;user-select:none;display:flex;align-items:center;gap:4px;
  }
  .toggle-btn:hover{color:#333}

  .hidden{display:none}

  /* === 완료 모달 === */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.45);
    display:none;align-items:center;justify-content:center;z-index:1000;
  }
  .modal{
    width:min(520px,92vw);background:#fff;border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.18);padding:28px 24px;text-align:center;
  }
  .modal h3{margin:6px 0 10px;font-size:22px}
  .modal p{margin:0 0 20px;color:#6b7280}
  .modal .ok-btn{
    display:inline-block;margin-top:4px;padding:12px 18px;border-radius:12px;background:#111827;color:#fff;
    text-decoration:none;cursor:pointer;font-weight:700;box-shadow:var(--shadow);
  }
  .modal-backdrop.open{display:flex}
</style>
</head>
<body>
  <header class="topbar">
    <!-- 로고 클릭 시 intro_login.html 이동 -->
    <a class="logo" href="{% url 'user:index' %}">Room Mate</a>
    <!-- 로그아웃 클릭 시 login.html 이동 -->
    <a class="toplink" href="{% url 'user:logout' %}">로그아웃</a>
  </header>

  <main class="wrap">
    <div class="container">
      <h1 class="title">비밀번호 수정</h1>

      <!-- 단계표시 -->
      <div class="steps">
        <div id="ind1" class="step active" title="이메일 인증으로 돌아가기"><span class="dot">1</span><span>이메일 인증</span></div>
        <div id="ind2" class="step"><span class="dot">2</span><span>비밀번호 수정</span></div>
      </div>

      <!-- ===== 1단계: 이메일 인증 ===== -->
      <section id="step1" class="section">
        <div class="label-strong">이메일 입력</div>
        <p class="help">회원가입시 사용했던 이메일을 입력해주세요</p>
        <div class="row">
          <input id="email" type="email" placeholder="이메일 (e.g. email@gmail.com)" />
          <button type="button" class="btn btn-slim" id="btnSend">전송</button>
        </div>

        <div id="verifyArea" style="display:none;">
          <div class="label-strong">이메일 인증</div>
          <p class="help">해당 이메일로 전송된 검증 코드를 입력해주세요</p>

          <div class="row">
            <div class="input-wrap">
              <input id="code" type="text" placeholder="XXXX - XXXX" maxlength="11" />
              <span id="timer" class="timer">3:00</span>
            </div>
            <button type="button" class="btn btn-slim" id="btnCheck">확인</button>
          </div>

          <div class="resend">검증 코드가 오지 않았나요? <a href="#" id="resend">재전송</a></div>
        </div>

        <div class="actions">
          <button class="btn btn-next" id="toStep2" disabled>다음</button>
        </div>
      </section>

      <!-- ===== 2단계: 비밀번호 수정 ===== -->
      <section id="step2" class="section hidden">
        <div class="label-strong">비밀번호 (8~16자, 영문 대소문자 / 숫자 / 특수문자 포함)</div>
        <div class="input-wrap">
          <input id="pw" type="password" placeholder="새 비밀번호를 입력하세요" />
          <span class="toggle-btn" data-target="pw">👁 Hide</span>
        </div>

        <div class="label-strong">비밀번호 재입력</div>
        <div class="input-wrap">
          <input id="pw2" type="password" placeholder="비밀번호를 다시 입력하세요" />
          <span class="toggle-btn" data-target="pw2">👁 Hide</span>
        </div>

        <div class="actions">
          <button class="btn btn-next" id="finish">다음</button>
        </div>
      </section>
    </div>
  </main>

  <!-- === 완료 모달 === -->
  <div id="doneModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="doneTitle">
    <div class="modal" id="modalCard">
      <h3 id="doneTitle">비밀번호가 재설정되었습니다</h3>
      <p>확인을 클릭하면 채팅 화면으로 이동합니다.</p>
      <span class="ok-btn" id="goChatBtn">확인</span>
    </div>
  </div>

<script>
/* ===== 1단계: 이메일 인증 ===== */
let timerInterval; let remaining=0; let verified=false;

const emailEl = document.getElementById('email');
const codeEl  = document.getElementById('code');
const timerEl = document.getElementById('timer');
const btnSend = document.getElementById('btnSend');
const btnCheck= document.getElementById('btnCheck');
const btnNext = document.getElementById('toStep2');
const resend  = document.getElementById('resend');
const verifyArea = document.getElementById('verifyArea');

function formatTime(sec){const m=Math.floor(sec/60);const s=String(sec%60).padStart(2,'0');return `${m}:${s}`;}
function startTimer(d=180){
  clearInterval(timerInterval); remaining=d;
  timerEl.textContent=formatTime(remaining); timerEl.style.color='#ef4444';
  timerInterval=setInterval(()=>{
    remaining--; timerEl.textContent=formatTime(Math.max(remaining,0));
    if(remaining<=0){ clearInterval(timerInterval); timerEl.textContent='만료'; timerEl.style.color='#999'; verified=false; btnNext.disabled=true; }
  },1000);
}

btnSend.addEventListener('click', ()=>{
  const email=emailEl.value.trim();
  if(!email){ alert('이메일을 입력해주세요.'); return; }
  verifyArea.style.display='block';
  startTimer();
  alert('인증코드가 '+email+' 로 전송되었습니다.');
  codeEl.value=''; codeEl.focus();
});

resend.addEventListener('click', (e)=>{
  e.preventDefault();
  if(remaining>0){ alert('아직 시간이 남았습니다. ('+formatTime(remaining)+')'); return; }
  startTimer(); alert('인증코드를 재전송했습니다.');
  codeEl.value=''; codeEl.focus();
});

codeEl.addEventListener('input', (e)=>{
  let v=e.target.value.replace(/\D/g,'').slice(0,8);
  if(v.length>4) v=v.slice(0,4)+' - '+v.slice(4);
  e.target.value=v;
});

btnCheck.addEventListener('click', ()=>{
  if(remaining<=0){ alert('시간이 만료되었습니다. 재전송 후 다시 시도해주세요.'); return; }
  const digits=codeEl.value.replace(/\D/g,'');
  if(digits.length!==8){ alert('8자리 코드를 입력하세요.'); return; }
  verified=true; alert('이메일 인증이 완료되었습니다.');
  btnNext.disabled=false;
});

/* ===== 단계 전환 ===== */
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const ind1 = document.getElementById('ind1');
const ind2 = document.getElementById('ind2');

function goToStep2(){
  if(!verified){ alert('이메일 인증을 완료하세요.'); return; }
  step1.classList.add('hidden');
  step2.classList.remove('hidden');
  ind1.classList.remove('active');
  ind2.classList.add('active');

  // 2단계에 있을 때만 1번 인디케이터를 클릭 가능하도록
  ind1.classList.add('clickable');
  document.getElementById('pw').focus();
}

function goToStep1(){
  step2.classList.add('hidden');
  step1.classList.remove('hidden');
  ind2.classList.remove('active');
  ind1.classList.add('active');

  // 1단계로 돌아오면 클릭 비활성화(의미상)
  ind1.classList.remove('clickable');
}

btnNext.addEventListener('click', goToStep2);

/* 2 → 1: 1번 인디케이터 클릭으로만 이동(입력 값 유지) */
ind1.addEventListener('click', ()=>{
  if(ind1.classList.contains('clickable')){ goToStep1(); }
});

/* ===== 2단계: 비밀번호 수정 ===== */
function togglePw(id, el){
  const input=document.getElementById(id);
  if(input.type==='password'){ input.type='text'; el.textContent='Show'; }
  else { input.type='password'; el.textContent='👁 Hide'; }
  input.focus(); const v=input.value; input.value=''; input.value=v;
}

document.querySelectorAll('.toggle-btn').forEach(el=>{
  el.addEventListener('click', ()=>togglePw(el.dataset.target, el));
});

/* 완료 모달 제어 */
const doneModal = document.getElementById('doneModal');
const modalCard = document.getElementById('modalCard');
const goChatBtn = document.getElementById('goChatBtn');
function openModal(){ doneModal.classList.add('open'); }
function closeAndGo(){ window.location.href='chat.html'; }

goChatBtn.addEventListener('click', closeAndGo);
/* 모달 바깥 클릭 시에도 이동 */
doneModal.addEventListener('click', closeAndGo);
/* 모달 카드 내부 클릭은 버블링 막기 */
modalCard.addEventListener('click', e=>e.stopPropagation());

document.getElementById('finish').addEventListener('click', ()=>{
  const pw  = document.getElementById('pw').value.trim();
  const pw2 = document.getElementById('pw2').value.trim();

  if(!pw || !pw2){ alert('비밀번호를 모두 입력해주세요.'); return; }
  if(pw.length < 8 || pw.length > 16){ alert('비밀번호는 8~16자여야 합니다.'); return; }

  const hasSpecial = /[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\;]/.test(pw);
  if(!hasSpecial){ alert('비밀번호에는 반드시 특수문자가 포함되어야 합니다.'); return; }

  if(pw !== pw2){ alert('비밀번호가 일치하지 않습니다.'); return; }

  // 서버 연동 위치: 실제 변경 API 성공 후 모달 표시
  openModal();
});
</script>
</body>
</html>
